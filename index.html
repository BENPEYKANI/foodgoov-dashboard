<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FoodGoov ‚Äî Dashboard</title>

  <!-- QRCode (pour le bouton Partager) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- Tailwind CDN + plugins -->
  <script>
    /* La config DOIT √™tre d√©finie avant le script CDN */
    tailwind = {
      config: {
        darkMode: 'class',
        theme: { extend: {} },
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- Police -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Styles simples utilitaires -->
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0b1220;color:#e6e8ec}
    .page{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:#0f172a;border:1px solid #1f2a44;border-radius:16px;padding:16px}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:10px;padding:.6rem 1rem;font-weight:600}
    .btn-primary{background:#0f172a;border:1px solid #334155}
    .btn-primary:hover{background:#111827}
    .btn-muted{background:#0b1220;border:1px solid #334155}
    .field{border:1px solid #334155;background:#0b1220;border-radius:10px;padding:.55rem .8rem}
    .label{font-size:.8rem;color:#9aa4b2}
    .tag{font-size:.7rem;color:#9aa4b2}
    .link{color:#60a5fa}
    .link:hover{text-decoration:underline}
    canvas{image-rendering:pixelated}
  </style>
</head>
<body class="min-h-screen">
  <main class="page">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-white text-black grid place-items-center text-sm font-bold">FG</div>
        <div>
          <h1 class="text-xl font-semibold">FoodGoov ‚Äî Dashboard</h1>
          <div class="tag">Tra√ßabilit√© ‚Ä¢ Tokens ‚Ä¢ V√©rification</div>
        </div>
      </div>
      <div>
        <span class="label mr-2">Statut :</span>
        <span id="statusPill" class="inline-flex items-center gap-2 rounded-full px-3 py-1 border border-[#334155] text-xs">Hors ligne</span>
      </div>
    </header>

    <!-- Ligne 1 -->
    <section class="grid md:grid-cols-3 gap-4 mb-6">
      <!-- API Base URL -->
      <div class="card">
        <div class="label mb-2">API Base URL</div>
        <input id="apiBase" class="field w-full" placeholder="https://foodgoov.onrender.com" />
        <div class="tag mt-2">M√©moris√© localement sur cet appareil.</div>
      </div>

      <!-- Session -->
      <div class="card">
        <div class="label mb-2">Session</div>
        <div id="sessionInfo" class="text-sm">‚Äî</div>
      </div>

      <!-- Actions -->
      <div class="card">
        <div class="label mb-3">Actions</div>
        <div class="flex gap-3">
          <button id="testBtn"  class="btn btn-muted"   type="button">Tester API publique</button>
          <button id="loadBtn"  class="btn btn-primary" type="button">Charger mes tokens</button>
        </div>
      </div>
    </section>

    <!-- Ligne 2 -->
    <section class="grid md:grid-cols-2 gap-4 mb-6">
      <!-- Mes tokens -->
      <div class="card">
        <div class="flex items-center justify-between">
          <div class="label">Mes tokens</div>
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
              <span class="label">Limit</span>
              <input id="listLimit" class="field w-20" value="25" />
            </div>
            <div class="flex items-center gap-2">
              <span class="label">Offset</span>
              <input id="listOffset" class="field w-20" value="0" />
            </div>
            <button id="refreshBtn" class="btn btn-muted" type="button">Refresh</button>
          </div>
        </div>
        <div id="tokensList" class="mt-3 text-sm">‚Äî</div>
      </div>

      <!-- Mint -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-300">Mint (authentifi√©)</h3>
          <span class="tag">POST /v1/tokens</span>
        </div>

        <textarea id="mintBody" class="field w-full h-64 font-mono text-sm">
{
  "product": {
    "category": "wine",
    "domain_id": "DOM-001",
    "vintage_year": 2024,
    "batch_code": "BATCH-001",
    "quantity": { "unit": "bottle", "count": 1200 }
  },
  "issuance": {
    "issued_at": "2025-10-22T12:00:00Z",
    "issuer": "FoodGoov",
    "producer_id": "DOMAINE-MASSEMBRE"
  }
}
        </textarea>

        <div class="mt-3 flex items-center gap-3">
          <button id="mintBtn" class="btn btn-primary" type="button">Mint token</button>
        </div>
        <div id="mintResult" class="text-sm text-gray-400 mt-2"></div>

        <!-- QR / Partage -->
        <div id="qrSection" class="hidden mt-5 border-t border-[#334155] pt-4 text-center">
          <canvas id="qrCanvas" class="mx-auto mb-2"></canvas>
          <button id="shareBtn" class="btn btn-muted text-sm" type="button">Copier</button>
          <p id="shareLink" class="text-[11px] text-gray-400 mt-2"></p>
        </div>
      </div>
    </section>

    <!-- Ligne 3 : Auth -->
    <section class="grid md:grid-cols-2 gap-4">
      <!-- Connexion -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-300 mb-3">Authentification ‚Äî Connexion</h3>
        <div class="grid grid-cols-3 gap-3 items-center">
          <input id="loginEmail"    class="field md:col-span-1" placeholder="Email" />
          <input id="loginPassword" class="field md:col-span-1" type="password" placeholder="Mot de passe" />
          <button id="loginBtn" class="btn btn-primary md:col-span-1" type="button">Se connecter</button>
        </div>
      </div>

      <!-- Cr√©ation -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-300 mb-3">Authentification ‚Äî Cr√©ation de compte</h3>
        <div class="grid grid-cols-4 gap-3 items-center">
          <input id="signupDisplay"  class="field md:col-span-1" placeholder="Nom producteur (affich√©)" />
          <input id="signupEmail"    class="field md:col-span-1" placeholder="Email" />
          <input id="signupPassword" class="field md:col-span-1" type="password" placeholder="Mot de passe" />
          <button id="signupBtn" class="btn btn-muted md:col-span-1" type="button">Cr√©er mon compte</button>
        </div>
      </div>
    </section>

    <footer class="max-w-7xl mx-auto px-4 py-8 text-center text-[11px] text-gray-400">
      FoodGoov garantit l‚Äôunicit√© cryptographique du lot et sa d√©claration par le producteur / √©metteur enregistr√©.
    </footer>
  </main>

  <!-- Script principal -->
<script>
/* ============ Helpers g√©n√©raux ============ */
function $(sel){ return document.querySelector(sel) }
function text(el, v){ if(el) el.textContent = v }

/* Cl√©s locales */
const LS_BASE   = "fg_api_base"
const LS_SESS   = "fg_session_token"
const LS_NAME   = "fg_session_name"

/* R√©cup affichages */
function apiBase(){ return ($("#apiBase")?.value || "").trim() }
function sessionToken(){ return localStorage.getItem(LS_SESS) || "" }
function setSessionDisplay(){
  const name = localStorage.getItem(LS_NAME) || "‚Äî"
  const sess = sessionToken()
  const short = sess ? (sess.slice(0,7)+"‚Ä¶") : "‚Äî"
  text($("#sessionBox"), `${name} ‚Ä¢ ${short}`)
  // statut en haut √† droite (si existe)
  const st = $("#statusDot"); if(st){ st.textContent = sess ? "En ligne" : "Hors ligne" }
}

/* Sauvegarde API base dans l‚Äôinput */
(function boot(){
  const base = localStorage.getItem(LS_BASE) || "https://foodgoov.onrender.com"
  if($("#apiBase")) $("#apiBase").value = base
  setSessionDisplay()
})();

/* Persister API base au changement */
$("#apiBase")?.addEventListener("change", e=>{
  localStorage.setItem(LS_BASE, apiBase())
})

/* ============ Auth ============ */
async function signup(){
  const base = apiBase()
  const display = $("#signupDisplay")?.value?.trim()
  const email   = $("#signupEmail")?.value?.trim()?.toLowerCase()
  const pass    = $("#signupPassword")?.value || ""

  if(!base || !display || !email || !pass){ return alert("Champs manquants.") }

  try{
    const r = await fetch(base + "/v1/auth/signup", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ display_name: display, email, password: pass })
    })
    const data = await r.json()
    if(!r.ok){ throw new Error(data.detail || r.status) }

    // stocker session + nom
    localStorage.setItem(LS_SESS, data.session_token)
    localStorage.setItem(LS_NAME, data.display_name || display)
    setSessionDisplay()
    alert("Compte cr√©√© üëç")
  }catch(err){ alert("Erreur signup : " + err.message) }
}

async function login(){
  const base = apiBase()
  const email = $("#loginEmail")?.value?.trim()?.toLowerCase()
  const pass  = $("#loginPassword")?.value || ""
  if(!base || !email || !pass){ return alert("Champs manquants.") }

  try{
    const r = await fetch(base + "/v1/auth/login", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ email, password: pass })
    })
    const data = await r.json()
    if(!r.ok){ throw new Error(data.detail || r.status) }

    localStorage.setItem(LS_SESS, data.session_token)
    localStorage.setItem(LS_NAME, data.display_name || "‚Äî")
    setSessionDisplay()
    alert("Connect√© : " + (data.display_name || "‚Äî"))
  }catch(err){ alert("Erreur login : " + err.message) }
}

/* ============ Test API publique ============ */
async function testPublicApi(){
  const base = apiBase()
  if(!base) return alert("Renseigne l‚ÄôAPI Base URL")
  try{
    const r = await fetch(base + "/v1/status")
    const j = await r.json()
    alert("Statut : " + (j.message || JSON.stringify(j)))
  }catch(e){ alert("√âchec : " + e.message) }
}

/* ============ Mes tokens (auth) ============ */
async function loadMyTokens(){
  const base = apiBase()
  const sess = sessionToken()
  const limit  = parseInt($("#listLimit")?.value || "25", 10)
  const offset = parseInt($("#listOffset")?.value || "0", 10)
  const box = $("#myTokensBox")
  if(box) text(box, "‚Äî")

  if(!base) return alert("Renseigne l‚ÄôAPI Base URL")
  if(!sess) return alert("Connecte-toi d'abord")

  try{
    const r = await fetch(`${base}/v1/admin/my-tokens?limit=${limit}&offset=${offset}`, {
      headers: { "x-session": sess }
    })
    const data = await r.json()
    if(!r.ok){ throw new Error(data.detail || r.status) }

    if(!data.items?.length){
      if(box) text(box, "Aucun lot")
      return
    }
    if(box){
      box.innerHTML = data.items.map(it => (
        `<div class="text-[13px] mb-1">
           <span class="font-semibold">${it.token_id}</span>
           ‚Äî ${it.category} ‚Ä¢ ${it.domain_id} ‚Ä¢ ${it.vintage_year} ‚Ä¢ ${it.batch_code}
         </div>`
      )).join("")
    }
  }catch(err){
    alert("Chargement √©chou√© : " + err.message)
  }
}

/* ============ Mint token (auth) ============ */
async function mintToken(){
  const base = apiBase()
  const sess = sessionToken()
  const resultEl = $("#mintResult")

  if(!base) return alert("Renseigne l‚ÄôAPI Base URL")
  if(!sess) return alert("Connecte-toi d'abord")

  let body
  try{
    body = JSON.parse($("#mintBody")?.value || "{}")
  }catch(e){
    return alert("JSON invalide dans le bloc Mint")
  }

  text(resultEl, "‚è≥ Envoi‚Ä¶")
  try{
    const r = await fetch(base + "/v1/tokens", {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "x-session": sess   // <<<<<< ESSENTIEL
      },
      body: JSON.stringify(body)
    })
    const data = await r.json()
    if(!r.ok){ throw new Error(data.detail || r.status) }

    text(resultEl, "‚úÖ Token cr√©√© : " + data.token_id)

    // QR automatique s‚Äôil y a un lien
    if(data.qr_url){ renderQR(data.qr_url) }
    else {
      // sinon, fabrique l‚ÄôURL de v√©rif √† partir du token_id
      const url = `${location.origin}/verify.html?token_id=${encodeURIComponent(data.token_id)}`
      renderQR(url)
    }
  }catch(err){
    text(resultEl, "‚ùå Erreur : " + err.message)
    alert("Load failed : " + err.message)
  }
}

/* ============ QR Code & Partage ============ */
function renderQR(url){
  const sec = $("#qrSection")
  const cvs = $("#qrCanvas")
  const link = $("#shareLink")
  if(!sec || !cvs) return
  try{
    sec.classList.remove("hidden")
    // lib qr-code d√©j√† charg√©e via CDN dans <head>
    const qr = new QRCode(cvs, { width: 220, height: 220 })
    // si la lib dessine sur un canvas existant, on clean avant
    if(cvs.innerHTML){ cvs.innerHTML = "" }
    new QRCode(cvs, url)
    if(link){ link.textContent = url }
  }catch(e){
    console.error(e)
  }
}

async function copyShareLink(){
  const link = $("#shareLink")?.textContent || ""
  if(!link) return
  try{
    await navigator.clipboard.writeText(link)
    alert("Lien copi√© ‚úÖ")
  }catch(e){
    alert("Impossible de copier : " + e.message)
  }
}

/* ============ Expose aux boutons HTML ============ */
window.signup = signup
window.login = login
window.testPublicApi = testPublicApi
window.loadMyTokens = loadMyTokens
window.mintToken = mintToken
window.copyShareLink = copyShareLink
</script>
</body>
</html>
