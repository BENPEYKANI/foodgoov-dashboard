<!doctype html>
<html lang="fr" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FoodGoov — Dashboard</title>

  <!-- QRCode CDN (pour générer le QR du lien de vérification) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- Tailwind CDN + plugins -->
  <script>
    /* La config DOIT être définie avant le script CDN Tailwind */
    tailwind = {
      config: {
        darkMode: 'class',
        theme: { extend: {} }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- Police Inter (optionnel) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <style>
    body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .btn { @apply px-4 py-2 rounded-lg text-sm font-semibold shadow border border-gray-200; }
    .btn-primary { @apply bg-indigo-700 text-white hover:bg-indigo-800; }
    .btn-muted { @apply bg-gray-100 text-gray-800 hover:bg-gray-200; }
    .card { @apply rounded-2xl border border-gray-200 p-5 bg-white; }
    .field { @apply w-full rounded-lg border-gray-300; }
    .tag { @apply text-[11px] px-2 py-0.5 rounded-full bg-gray-100; }
  </style>
</head>
<body class="bg-gray-50 min-h-full">
  <header class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-full bg-black text-white grid place-items-center font-semibold">FG</div>
        <div>
          <h1 class="text-xl font-semibold">FoodGoov — Dashboard</h1>
          <p class="text-xs text-gray-500">Traçabilité • Tokens • Vérification</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class="text-sm text-gray-500">Statut :</span>
        <span id="statusBadge" class="text-xs px-2 py-1 rounded-full bg-gray-100">Hors ligne</span>
        <button id="connectBtn" class="btn btn-primary">Se connecter</button>
        <button id="disconnectBtn" class="btn btn-muted hidden">Se déconnecter</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-16">
    <!-- Ligne 1 -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-5">
      <!-- API Base -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-700 mb-2">API Base URL</h3>
        <input id="apiBase" class="field" placeholder="https://foodgoov.onrender.com" />
        <p class="text-[11px] text-gray-400 mt-2">Mémorisé localement sur cet appareil.</p>
      </div>

      <!-- Session -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Session</h3>
        <div id="sessionBox" class="text-sm text-gray-500">—</div>
      </div>

      <!-- Actions -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Actions</h3>
        <div class="flex gap-3 flex-wrap">
          <button id="testBtn" class="btn btn-muted">Tester API publique</button>
          <button id="loadBtn" class="btn btn-muted">Charger mes tokens</button>
        </div>
      </div>
    </section>

    <!-- Ligne 2 -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-5 mt-6">
      <!-- Mes tokens -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-700">Mes tokens</h3>
          <div class="flex items-center gap-2">
            <label class="text-xs text-gray-500">Limit</label>
            <input id="limit" class="field w-20" value="25" />
            <label class="text-xs text-gray-500">Offset</label>
            <input id="offset" class="field w-20" value="0" />
            <button class="btn btn-muted" onclick="loadMyTokens()">Refresh</button>
          </div>
        </div>
        <div id="myTokens" class="text-sm text-gray-700 border-t pt-3">—</div>
      </div>

      <!-- Mint -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-700">Mint (authentifié)</h3>
          <span class="tag">POST /v1/tokens</span>
        </div>

        <textarea id="mintBody" class="field font-mono text-sm w-full h-56">
{
  "product": {
    "category": "wine",
    "domain_id": "DOM-001",
    "vintage_year": 2024,
    "batch_code": "BATCH-001",
    "quantity": { "unit": "bottle", "count": 1200 }
  },
  "issuance": {
    "issued_at": "2025-10-22T12:00:00Z",
    "issuer": "FoodGoov",
    "producer_id": "DOMAINE-MASSEMBRE"
  }
}
        </textarea>

        <div class="mt-3 flex items-center gap-3">
          <button id="mintBtn" class="btn btn-primary">Mint token</button>
          <div id="mintResult" class="text-sm text-gray-500"></div>
        </div>

        <!-- Résultat + QR -->
        <div id="qrSection" class="hidden mt-5 border-t border-gray-200 pt-4 text-center">
          <canvas id="qrCanvas" class="mx-auto mb-2"></canvas>
          <div class="flex items-center justify-center gap-3">
            <button id="shareBtn" class="btn btn-muted text-sm">Copier le lien</button>
            <p id="shareLink" class="text-[11px] text-gray-500 break-all"></p>
          </div>
        </div>
      </div>
    </section>

    <!-- Ligne 3 : Auth -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-5 mt-6">
      <!-- Connexion -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Authentification — Connexion</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-center">
          <input id="loginEmail" class="field md:col-span-1" placeholder="Email" />
          <input id="loginPassword" class="field md:col-span-1" placeholder="Mot de passe" type="password" />
          <button id="loginBtn" class="btn btn-primary md:col-span-1">Se connecter</button>
        </div>
      </div>

      <!-- Création de compte -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Authentification — Création de compte</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-center">
          <input id="signupDisplay" class="field md:col-span-2" placeholder="Nom producteur (affiché)" />
          <input id="signupEmail" class="field md:col-span-1" placeholder="Email" />
          <input id="signupPassword" class="field md:col-span-1" placeholder="Mot de passe" type="password" />
          <button id="signupBtn" class="btn btn-muted md:col-span-4">Créer mon compte</button>
        </div>
      </div>
    </section>

    <footer class="max-w-6xl mx-auto px-4 py-10 text-center text-[11px] text-gray-400">
      FoodGoov garantit l’unicité cryptographique du lot et sa déclaration par le producteur / émetteur enregistré.
    </footer>
  </main>

  <!-- =========================
       SCRIPT PRINCIPAL
       ========================= -->
  <script>
/* ========= Helpers UI / Debug ========= */
function toast(msg, ok=true) {
  let box = document.getElementById('fg_toast');
  if (!box) {
    box = document.createElement('div');
    box.id = 'fg_toast';
    box.style.position = 'fixed';
    box.style.left = '50%';
    box.style.bottom = '18px';
    box.style.transform = 'translateX(-50%)';
    box.style.zIndex = '99999';
    box.style.maxWidth = '90%';
    box.style.fontSize = '14px';
    box.style.padding = '10px 14px';
    box.style.borderRadius = '10px';
    box.style.boxShadow = '0 6px 18px rgba(0,0,0,.15)';
    box.style.color = '#fff';
    box.style.textAlign = 'center';
    document.body.appendChild(box);
  }
  box.style.background = ok ? '#16a34a' : '#b91c1c';
  box.textContent = msg;
  box.style.opacity = '1';
  setTimeout(()=>{ box.style.opacity = '0'; }, 2800);
}
// Attrape les erreurs JS globales (utile sur iPad sans console)
window.addEventListener('error', (e)=>{
  toast('JS Error: ' + (e.message || e.error?.message || 'inconnu'), false);
});

/* ========= Sélecteurs (doivent exister dans le HTML) ========= */
const elApiBase     = document.getElementById('apiBase') || document.querySelector('input[placeholder^="https://"]');
const elSession     = document.getElementById('sessionInfo') || document.querySelector('[data-session]') || document.querySelectorAll('section,div,span')[0];
const elTokensBox   = document.getElementById('tokensBox') || document.querySelector('.tokens-box') || document.querySelectorAll('section,div')[10];
const elLimit       = document.getElementById('limit')  || document.querySelector('input#limit')  || document.querySelectorAll('input[type="number"]')[0];
const elOffset      = document.getElementById('offset') || document.querySelector('input#offset') || document.querySelectorAll('input[type="number"]')[1];

const elLoginEmail    = document.getElementById('loginEmail')    || document.querySelector('input[placeholder="Email"]');
const elLoginPassword = document.getElementById('loginPassword') || document.querySelector('input[placeholder^="Mot de passe"],input[type="password"]');

const elSignupDisplay  = document.getElementById('signupDisplay')  || document.querySelector('input[placeholder^="Nom producteur"]');
const elSignupEmail    = document.getElementById('signupEmail')    || document.querySelectorAll('input[placeholder="Email"]')[1];
const elSignupPassword = document.getElementById('signupPassword') || document.querySelectorAll('input[type="password"]')[1];

const elMintBody   = document.getElementById('mintBody')   || document.querySelector('textarea');
const elMintResult = document.getElementById('mintResult') || document.querySelector('#mintResult');

const elQrSection  = document.getElementById('qrSection')  || document.querySelector('#qrSection');
const elQrCanvas   = document.getElementById('qrCanvas')   || document.querySelector('#qrCanvas');
const elShareBtn   = document.getElementById('shareBtn')   || document.querySelector('#shareBtn');
const elShareLink  = document.getElementById('shareLink')  || document.querySelector('#shareLink');

/* ========= Stockage local ========= */
function getApiBase() {
  return (elApiBase?.value?.trim()) || localStorage.getItem('fg_api_base') || '';
}
function setApiBase(val) {
  if (!val) return;
  localStorage.setItem('fg_api_base', val);
  if (elApiBase) elApiBase.value = val;
}
function setSession(sessToken, displayName) {
  localStorage.setItem('fg_session', sessToken);
  localStorage.setItem('fg_display', displayName || '');
  if (elSession) elSession.textContent = (displayName || '—') + ' • ' + (sessToken || '—').slice(0,10) + '…';
}
function getSession() {
  return localStorage.getItem('fg_session') || '';
}

/* ========= Helper HTTP ========= */
async function http(method, path, body, {auth=false} = {}) {
  const base = getApiBase();
  if (!base) throw new Error("API Base URL manquante");
  const url = base.replace(/\/+$/,'') + path;
  const headers = {"Content-Type": "application/json"};
  if (auth) {
    const sess = getSession();
    if (!sess) throw new Error("Pas de session. Connecte-toi.");
    headers['x-session'] = sess; // backend accepte x-session
  }
  const res = await fetch(url, {
    method,
    headers,
    body: body ? JSON.stringify(body) : undefined
  });
  if (!res.ok) {
    const txt = await res.text().catch(()=> '');
    throw new Error(`HTTP ${res.status}: ${txt || res.statusText}`);
  }
  // certaines routes renvoient du JSON
  const ct = res.headers.get('content-type') || '';
  if (ct.includes('application/json')) return await res.json();
  return await res.text();
}

/* ========= Actions UI (liées aux boutons) ========= */
async function testPublic() {
  try {
    const data = await http('GET', '/v1/anchors/latest');
    toast('API OK: anchor=' + (Array.isArray(data?.items) ? data.items.length : '—'));
  } catch (e) {
    toast(e.message, false);
  }
}

async function loadMyTokens() {
  try {
    const l = parseInt(elLimit?.value || '25', 10) || 25;
    const o = parseInt(elOffset?.value || '0', 10) || 0;
    const data = await http('GET', `/v1/admin/my-tokens?limit=${l}&offset=${o}`, null, {auth:true});
    const items = data?.items || [];
    if (elTokensBox) {
      elTokensBox.innerHTML = items.length
        ? items.map(t => `<div class="text-[12px] mb-2">
            <div class="font-semibold">${t.domain_id} • ${t.vintage_year} • ${t.batch_code}</div>
            <div class="text-gray-500 break-all">${t.token_id}</div>
          </div>`).join('')
        : '<div class="text-gray-400 text-sm">Aucun token.</div>';
    }
    toast(`Chargé: ${items.length} lot(s)`);
  } catch (e) {
    toast(e.message, false);
  }
}

async function login() {
  try {
    const email = elLoginEmail?.value?.trim();
    const password = elLoginPassword?.value || '';
    if (!email || !password) throw new Error("Email et mot de passe requis.");
    const data = await http('POST', '/v1/auth/login', {email, password});
    setSession(data.session_token, data.display_name);
    toast('Connecté : ' + (data.display_name || email));
  } catch (e) {
    toast(e.message, false);
  }
}

async function signup() {
  try {
    const display_name = elSignupDisplay?.value?.trim();
    const email = elSignupEmail?.value?.trim();
    const password = elSignupPassword?.value || '';
    if (!display_name || !email || !password) throw new Error("Tous les champs de création sont requis.");
    const data = await http('POST', '/v1/auth/signup', {display_name, email, password});
    setSession(data.session_token, data.display_name);
    toast('Compte créé : ' + data.display_name);
  } catch (e) {
    toast(e.message, false);
  }
}

function renderQR(tokenId, qrUrlFromApi) {
  try {
    if (!elQrSection || !elQrCanvas) return;
    elQrSection.classList.remove('hidden');
    const shareUrl = qrUrlFromApi || (location.origin + '/verify.html?token_id=' + tokenId);
    if (elShareBtn) {
      elShareBtn.onclick = async () => {
        try {
          await navigator.clipboard.writeText(shareUrl);
          if (elShareLink) elShareLink.textContent = shareUrl;
          toast('Lien copié');
        } catch { toast('Impossible de copier', false); }
      };
    }
    if (elShareLink) elShareLink.textContent = shareUrl;
    if (window.QRCode && QRCode.toCanvas) {
      QRCode.toCanvas(elQrCanvas, shareUrl, {width: 240}, (err)=>{
        if (err) toast('QR error: '+err.message, false);
      });
    } else {
      toast('Librairie QRCode introuvable', false);
    }
  } catch (e) {
    toast(e.message, false);
  }
}

async function mintToken() {
  try {
    // vérifier session
    const sess = getSession();
    if (!sess) throw new Error("Connecte-toi d'abord.");

    // lire le JSON du textarea
    let body;
    try {
      body = JSON.parse(elMintBody?.value || '{}');
    } catch {
      throw new Error("JSON invalide dans la zone Mint.");
    }
    const data = await http('POST', '/v1/tokens', body, {auth:true});
    const tokenId = data?.token_id;
    if (elMintResult) elMintResult.textContent = JSON.stringify(data, null, 2);
    if (tokenId) renderQR(tokenId, data?.qr_url);
    toast('Mint OK');
  } catch (e) {
    if (elMintResult) elMintResult.textContent = e.message;
    toast(e.message, false);
  }
}

/* ========= Wiring & init ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  // Pré-remplir base URL (mémorisée)
  const saved = localStorage.getItem('fg_api_base');
  if (saved && elApiBase) elApiBase.value = saved;
  if (elApiBase) {
    elApiBase.addEventListener('change', ()=> setApiBase(elApiBase.value.trim()));
    elApiBase.addEventListener('blur',   ()=> setApiBase(elApiBase.value.trim()));
  }
  // Afficher session si déjà stockée
  const sess = getSession();
  const name = localStorage.getItem('fg_display') || '';
  if (sess) setSession(sess, name);
});

// Expose pour les boutons inline (si ton HTML utilise onclick="...")
window.testPublic = testPublic;
window.loadMyTokens = loadMyTokens;
window.login = login;
window.signup = signup;
window.mintToken = mintToken;
</script>
</body>
</html>
