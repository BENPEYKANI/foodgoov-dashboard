<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FoodGoov ‚Äî Dashboard</title>

  <!-- QRCode (pour le bouton Partager) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- Tailwind CDN + plugins -->
  <script>
    /* La config DOIT √™tre d√©finie avant le script CDN */
    tailwind = {
      config: {
        darkMode: 'class',
        theme: { extend: {} },
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- Police -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Styles simples utilitaires -->
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0b1220;color:#e6e8ec}
    .page{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:#0f172a;border:1px solid #1f2a44;border-radius:16px;padding:16px}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:10px;padding:.6rem 1rem;font-weight:600}
    .btn-primary{background:#0f172a;border:1px solid #334155}
    .btn-primary:hover{background:#111827}
    .btn-muted{background:#0b1220;border:1px solid #334155}
    .field{border:1px solid #334155;background:#0b1220;border-radius:10px;padding:.55rem .8rem}
    .label{font-size:.8rem;color:#9aa4b2}
    .tag{font-size:.7rem;color:#9aa4b2}
    .link{color:#60a5fa}
    .link:hover{text-decoration:underline}
    canvas{image-rendering:pixelated}
  </style>
</head>
<body class="min-h-screen">
  <main class="page">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-white text-black grid place-items-center text-sm font-bold">FG</div>
        <div>
          <h1 class="text-xl font-semibold">FoodGoov ‚Äî Dashboard</h1>
          <div class="tag">Tra√ßabilit√© ‚Ä¢ Tokens ‚Ä¢ V√©rification</div>
        </div>
      </div>
      <div>
        <span class="label mr-2">Statut :</span>
        <span id="statusPill" class="inline-flex items-center gap-2 rounded-full px-3 py-1 border border-[#334155] text-xs">Hors ligne</span>
      </div>
    </header>

    <!-- Ligne 1 -->
    <section class="grid md:grid-cols-3 gap-4 mb-6">
      <!-- API Base URL -->
      <div class="card">
        <div class="label mb-2">API Base URL</div>
        <input id="apiBase" class="field w-full" placeholder="https://foodgoov.onrender.com" />
        <div class="tag mt-2">M√©moris√© localement sur cet appareil.</div>
      </div>

      <!-- Session -->
      <div class="card">
        <div class="label mb-2">Session</div>
        <div id="sessionInfo" class="text-sm">‚Äî</div>
      </div>

      <!-- Actions -->
      <div class="card">
        <div class="label mb-3">Actions</div>
        <div class="flex gap-3">
          <button id="testBtn"  class="btn btn-muted"   type="button">Tester API publique</button>
          <button id="loadBtn"  class="btn btn-primary" type="button">Charger mes tokens</button>
        </div>
      </div>
    </section>

    <!-- Ligne 2 -->
    <section class="grid md:grid-cols-2 gap-4 mb-6">
      <!-- Mes tokens -->
      <div class="card">
        <div class="flex items-center justify-between">
          <div class="label">Mes tokens</div>
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
              <span class="label">Limit</span>
              <input id="listLimit" class="field w-20" value="25" />
            </div>
            <div class="flex items-center gap-2">
              <span class="label">Offset</span>
              <input id="listOffset" class="field w-20" value="0" />
            </div>
            <button id="refreshBtn" class="btn btn-muted" type="button">Refresh</button>
          </div>
        </div>
        <div id="tokensList" class="mt-3 text-sm">‚Äî</div>
      </div>

      <!-- Mint -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-300">Mint (authentifi√©)</h3>
          <span class="tag">POST /v1/tokens</span>
        </div>

        <textarea id="mintBody" class="field w-full h-64 font-mono text-sm">
{
  "product": {
    "category": "wine",
    "domain_id": "DOM-001",
    "vintage_year": 2024,
    "batch_code": "BATCH-001",
    "quantity": { "unit": "bottle", "count": 1200 }
  },
  "issuance": {
    "issued_at": "2025-10-22T12:00:00Z",
    "issuer": "FoodGoov",
    "producer_id": "DOMAINE-MASSEMBRE"
  }
}
        </textarea>

        <div class="mt-3 flex items-center gap-3">
          <button id="mintBtn" class="btn btn-primary" type="button">Mint token</button>
        </div>
        <div id="mintResult" class="text-sm text-gray-400 mt-2"></div>

        <!-- QR / Partage -->
<div id="qrSection" class="hidden mt-5 border-t border-[#334155] pt-4 text-center">
  <canvas id="qrCanvas" class="mx-auto mb-2"></canvas>

  <div class="flex justify-center gap-3 mb-3">
    <button id="shareBtn" class="btn btn-muted text-sm" type="button">Copier le lien</button>
    <button id="downloadQrBtn" class="btn btn-muted text-sm" type="button">T√©l√©charger le QR</button>
  </div>

  <p id="shareLink" class="text-[11px] text-gray-400 mb-3"></p>

  <!-- üîΩ Nouveau : code HTML √† int√©grer -->
  <textarea
    id="embedHtml"
    class="field w-full font-mono text-[11px] mt-2"
    rows="3"
    readonly
    placeholder="Code HTML du QR appara√Ætra ici apr√®s le mint‚Ä¶"
  ></textarea>
  <p class="text-[11px] text-gray-500 mt-1">
    (√Ä coller dans votre fiche produit / site vitrine / email HTML)
  </p>
</div>

    <!-- Ligne 3 : Auth -->
    <section class="grid md:grid-cols-2 gap-4">
      <!-- Connexion -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-300 mb-3">Authentification ‚Äî Connexion</h3>
        <div class="grid grid-cols-3 gap-3 items-center">
        <input id="loginEmail" class="field md:col-span-1" type="text" placeholder="Email (ex : benyamin_hadipeykani@yahoo.com)" />
        <input id="loginPassword" class="field md:col-span-1" type="password" placeholder="Mot de passe" />
          <button id="loginBtn" class="btn btn-primary md:col-span-1" type="button">Se connecter</button>
        </div>
      </div>

      <!-- Cr√©ation -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-300 mb-3">Authentification ‚Äî Cr√©ation de compte</h3>
        <div class="grid grid-cols-4 gap-3 items-center">
          <input id="signupDisplay"  class="field md:col-span-1" placeholder="Nom producteur (affich√©)" />
          <input id="signupEmail"    class="field md:col-span-1" placeholder="Email" />
          <input id="signupPassword" class="field md:col-span-1" type="password" placeholder="Mot de passe" />
          <button id="signupBtn" class="btn btn-muted md:col-span-1" type="button">Cr√©er mon compte</button>
        </div>
      </div>
    </section>

    <footer class="max-w-7xl mx-auto px-4 py-8 text-center text-[11px] text-gray-400">
      FoodGoov garantit l‚Äôunicit√© cryptographique du lot et sa d√©claration par le producteur / √©metteur enregistr√©.
    </footer>
  </main>

  <!-- Script principal -->
<script>
// --- petites fonctions utilitaires ---
function alertMsg(msg) {
  alert(msg);
}

function getApiBase() {
  const el = document.getElementById("apiBase");
  return el?.value?.trim() || "";
}

// --- R√©f√©rences DOM ---
const apiBaseEl       = document.getElementById("apiBase");
const statusPillEl    = document.getElementById("statusPill");
const sessionInfoEl   = document.getElementById("sessionInfo");
const tokensListEl    = document.getElementById("tokensList");
const listLimitEl     = document.getElementById("listLimit");
const listOffsetEl    = document.getElementById("listOffset");

const mintBodyEl      = document.getElementById("mintBody");
const mintResultEl    = document.getElementById("mintResult");
const qrSectionEl     = document.getElementById("qrSection");
const qrCanvasEl      = document.getElementById("qrCanvas");
const shareBtnEl      = document.getElementById("shareBtn");
const shareLinkEl     = document.getElementById("shareLink");
const downloadQrBtn   = document.getElementById("downloadQrBtn");
const embedHtmlEl     = document.getElementById("embedHtml");

const loginEmailEl    = document.getElementById("loginEmail");
const loginPasswordEl = document.getElementById("loginPassword");

const signupDisplayEl = document.getElementById("signupDisplay");
const signupEmailEl   = document.getElementById("signupEmail");
const signupPasswordEl= document.getElementById("signupPassword");

const testBtn   = document.getElementById("testBtn");
const loadBtn   = document.getElementById("loadBtn");
const refreshBtn= document.getElementById("refreshBtn");
const loginBtn  = document.getElementById("loginBtn");
const signupBtn = document.getElementById("signupBtn");
const mintBtn   = document.getElementById("mintBtn");

// --- stockage simple de la session c√¥t√© navigateur ---
let SESSION = null;           // { display_name, session_token, producer_id }
let LAST_TOKEN_ID = null;     // dernier token mint√©, utile pour le nom du fichier PNG

// Charger la session depuis localStorage
(function restoreSession() {
  try {
    const raw = localStorage.getItem("fg_session");
    if (raw) {
      SESSION = JSON.parse(raw);
      sessionInfoEl.textContent = `${SESSION.display_name} ¬∑ ${SESSION.session_token.slice(0,10)}‚Ä¶`;
      statusPillEl.textContent = "En ligne";
    }
  } catch (e) {
    console.warn("Impossible de restaurer la session", e);
  }
})();

// --- ping / status ---
async function ping() {
  const base = getApiBase();
  if (!base) {
    alertMsg("API Base URL manquante.");
    return false;
  }
  try {
    const r = await fetch(base + "/v1/status");
    if (!r.ok) throw new Error("HTTP " + r.status);
    await r.json();
    statusPillEl.textContent = "En ligne";
    return true;
  } catch (e) {
    console.error(e);
    statusPillEl.textContent = "Hors ligne";
    alertMsg("API indisponible");
    return false;
  }
}

// --- login / signup ---
async function doLogin() {
  const base = getApiBase();
  if (!base) { alertMsg("API Base URL manquante."); return; }

  const email = loginEmailEl.value.trim();
  const pw    = loginPasswordEl.value.trim();
  if (!email || !pw) { alertMsg("Email et mot de passe requis."); return; }

  try {
    const r = await fetch(base + "/v1/auth/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password: pw }),
    });
    const data = await r.json();
    if (!r.ok) throw new Error(data.detail || "Login √©chou√©");

    SESSION = data;
    localStorage.setItem("fg_session", JSON.stringify(SESSION));
    sessionInfoEl.textContent = `${data.display_name} ¬∑ ${data.session_token.slice(0,10)}‚Ä¶`;
    statusPillEl.textContent = "En ligne";
    alertMsg("Connect√© : " + data.display_name);
  } catch (e) {
    alertMsg("Erreur de connexion : " + (e.message || e));
  }
}

async function doSignup() {
  const base = getApiBase();
  if (!base) { alertMsg("API Base URL manquante."); return; }

  const display = signupDisplayEl.value.trim();
  const email   = signupEmailEl.value.trim();
  const pw      = signupPasswordEl.value.trim();
  if (!display || !email || !pw) { alertMsg("Tous les champs sont requis."); return; }

  try {
    const r = await fetch(base + "/v1/auth/signup", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ display_name: display, email, password: pw }),
    });
    const data = await r.json();
    if (!r.ok) throw new Error(data.detail || "Signup √©chou√©");

    SESSION = data;
    localStorage.setItem("fg_session", JSON.stringify(SESSION));
    sessionInfoEl.textContent = `${data.display_name} ¬∑ ${data.session_token.slice(0,10)}‚Ä¶`;
    statusPillEl.textContent = "En ligne";
    alertMsg("Compte cr√©√© : " + data.display_name);
  } catch (e) {
    alertMsg("Erreur cr√©ation compte : " + (e.message || e));
  }
}

// --- charger mes tokens ---
async function loadMyTokens() {
  const base = getApiBase();
  if (!base) { alertMsg("API Base URL manquante."); return; }
  if (!SESSION?.session_token) { alertMsg("Connecte-toi d'abord."); return; }

  const limit  = parseInt(listLimitEl.value || "25", 10);
  const offset = parseInt(listOffsetEl.value || "0", 10);

  try {
    const r = await fetch(`${base}/v1/admin/my-tokens?limit=${limit}&offset=${offset}`, {
      headers: { "x-session": SESSION.session_token },
    });
    const data = await r.json();
    if (!r.ok) throw new Error(data.detail || "Erreur chargement tokens");

    if (!data.items || data.items.length === 0) {
      tokensListEl.textContent = "Aucun token pour l‚Äôinstant.";
      return;
    }

    tokensListEl.textContent = data.items
      .map(t => `${t.token_id} ‚Äî ${t.category} / ${t.domain_id} / ${t.vintage_year} (${t.quantity.count} ${t.quantity.unit})`)
      .join("\n");
  } catch (e) {
    tokensListEl.textContent = "Erreur: " + (e.message || e);
  }
}

// --- Mint + QR + copie ---
async function doMint() {
  const base   = getApiBase();
  if (!base) { alertMsg("API Base URL manquante."); return; }

  const ok = await ping();
  if (!ok) return;
  if (!SESSION?.session_token) { alertMsg("Connecte-toi d'abord."); return; }

  let payload;
  try {
    payload = JSON.parse(mintBodyEl.value);
  } catch {
    alertMsg("JSON invalide dans la zone Mint.");
    return;
  }

  try {
    const r = await fetch(base + "/v1/tokens", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-session": SESSION.session_token,
      },
      body: JSON.stringify(payload),
    });
    const data = await r.json();
    if (!r.ok) throw new Error(data.detail || JSON.stringify(data));

    LAST_TOKEN_ID = data.token_id;  // m√©morise le dernier token
    mintResultEl.textContent = "‚úÖ Token cr√©√©: " + data.token_id;

    // G√©n√©ration du QR code dans le canvas (lib QRCode 1.5.3)
    let qrUrl = null;
    if (window.QRCode && qrCanvasEl) {
      try {
        qrUrl =
          data.qr_url ||
          (location.origin + "/verify.html?token_id=" + encodeURIComponent(data.token_id));

        const size = 512; // pixels
        qrCanvasEl.width  = size;
        qrCanvasEl.height = size;

        await QRCode.toCanvas(qrCanvasEl, qrUrl, {
          width: size,
          margin: 1,
        });
      } catch (err) {
        console.error("Erreur QR :", err);
        alertMsg("Impossible de g√©n√©rer le QR.");
      }
    }

    // QR + lien
  if (qrSectionEl && qrCanvasEl && shareLinkEl) {
  qrSectionEl.classList.remove("hidden");

  // Lien de v√©rification
  const qrUrl =
    data.qr_url ||
    (location.origin + "/verify.html?token_id=" + encodeURIComponent(data.token_id));
  shareLinkEl.textContent = qrUrl;

  // üîπ Code HTML int√©grable (image + lien)
  if (embedHtmlEl) {
    const apiBase = getApiBase().replace(/\/+$/, ""); // enl√®ve le / final au cas o√π
    const imgUrl  = apiBase + "/v1/tokens/" + encodeURIComponent(data.token_id) + "/qr";

    const htmlSnippet =
`<a href="${qrUrl}" target="_blank" rel="noopener">
  <img src="${imgUrl}"
       alt="QR FoodGoov pour le lot ${data.token_id}"
       width="220"
       height="220">
</a>`;

    embedHtmlEl.value = htmlSnippet;
  }

  // bouton "Copier le lien"
  if (shareBtnEl) {
    shareBtnEl.onclick = async () => {
      const text = shareLinkEl.textContent || "";
      if (!text) { alertMsg("Rien √† copier."); return; }

      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          alertMsg("Lien copi√© dans le presse-papiers üëç");
        } else {
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          const ok = document.execCommand("copy");
          document.body.removeChild(ta);
          if (ok) {
            alertMsg("Lien copi√© üëç");
          } else {
            alertMsg("Copie impossible, s√©lectionne le texte manuellement :\n" + text);
          }
        }
      } catch (e) {
        alertMsg("Copie impossible, s√©lectionne le texte manuellement :\n" + text);
      }
    };
  }
}
    
// --- Nouveau : t√©l√©chargement du QR ---
function downloadQR() {
  const base = getApiBase();
  if (!base) {
    alertMsg("API Base URL manquante.");
    return;
  }

  if (!LAST_TOKEN_ID) {
    alertMsg("Aucun token en m√©moire : clique d‚Äôabord sur Mint token.");
    return;
  }

  // URL de l‚ÄôAPI backend qui g√©n√®re le PNG du QR
  const url = base + "/v1/tokens/" + encodeURIComponent(LAST_TOKEN_ID) + "/qr";

  // Sur iPad / navigateur : on ouvre dans un nouvel onglet,
  // tu pourras l‚Äôenregistrer ou le partager depuis l‚Äôinterface
  window.open(url, "_blank");
}

// --- Bind des boutons ---
if (testBtn)      testBtn.onclick      = () => ping().then(ok => ok && alertMsg("API OK ‚úÖ"));
if (loadBtn)      loadBtn.onclick      = loadMyTokens;
if (refreshBtn)   refreshBtn.onclick   = loadMyTokens;
if (loginBtn)     loginBtn.onclick     = doLogin;
if (signupBtn)    signupBtn.onclick    = doSignup;
if (mintBtn)      mintBtn.onclick      = doMint;
if (downloadQrBtn)downloadQrBtn.onclick= downloadQR;

// Initialisation : si une session existe d√©j√†, on met √† jour le statut
if (SESSION) {
  statusPillEl.textContent = "En ligne";
}
</script>
</body>
</html>
