<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FoodGoov — Mini Dashboard</title>
  <meta name="description" content="Dashboard minimal pour visualiser et créer des tokens FoodGoov" />
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 + ReactDOM (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel pour compiler le JSX dans le navigateur (simple pour un fichier unique) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="min-h-screen bg-gray-50">
  <div id="root" class="max-w-6xl mx-auto px-4 py-8"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    const STORAGE_KEY = 'foodgoov_dash_cfg_v1';

    const Label = ({ children }) => (
      <div className="text-sm text-gray-500 mb-1">{children}</div>
    );
    const Field = ({ children }) => (
      <div className="mb-4">{children}</div>
    );
    const Card = ({ children }) => (
      <div className="bg-white rounded-2xl shadow p-6 border border-gray-100">{children}</div>
    );
    const Button = ({ children, className = '', ...props }) => (
      <button
        className={
          'px-4 py-2 rounded-2xl shadow hover:shadow-md transition text-sm font-medium ' +
          'bg-black text-white disabled:opacity-50 disabled:cursor-not-allowed ' + className
        }
        {...props}
      >{children}</button>
    );
    const Input = (props) => (
      <input {...props} className={`w-full rounded-xl border border-gray-200 px-3 py-2 outline-none focus:ring-2 focus:ring-black/20 ${props.className||''}`} />
    );
    const Textarea = (props) => (
      <textarea {...props} className={`w-full rounded-xl border border-gray-200 px-3 py-2 outline-none focus:ring-2 focus:ring-black/20 ${props.className||''}`} />
    );

    function useConfig(){
      const [apiBase, setApiBase] = useState('https://foodgoov.onrender.com');
      const [apiKey, setApiKey] = useState('');
      useEffect(()=>{
        try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw){ const j = JSON.parse(raw); if(j.apiBase) setApiBase(j.apiBase); if(j.apiKey) setApiKey(j.apiKey); } }catch{}
      },[]);
      useEffect(()=>{
        localStorage.setItem(STORAGE_KEY, JSON.stringify({apiBase, apiKey}));
      },[apiBase, apiKey]);
      return { apiBase, setApiBase, apiKey, setApiKey };
    }

    const prettyDate = (s) => { try{ if(!s) return ''; const d = new Date(s); return d.toLocaleString(); }catch{return s;} };

    const Copy = ({ text, label='Copier' }) => {
      const [ok, setOk] = useState(false);
      return (
        <button className="text-xs text-gray-600 hover:text-black underline" onClick={async()=>{ try{ await navigator.clipboard.writeText(text); setOk(true); setTimeout(()=>setOk(false),1200);}catch{} }}>
          {ok ? 'Copié !' : label}
        </button>
      );
    };

    function App(){
      const { apiBase, setApiBase, apiKey, setApiKey } = useConfig();
      const [status, setStatus] = useState('');
      const [loading, setLoading] = useState(false);
      const [tokens, setTokens] = useState([]);
      const [limit, setLimit] = useState(25);
      const [offset, setOffset] = useState(0);
      const [error, setError] = useState('');

      async function testConnection(){
        setStatus('Testing...'); setError('');
        try{ const r = await fetch(`${apiBase}/v1/anchors/latest`); if(!r.ok) throw new Error(`HTTP ${r.status}`); setStatus('OK — API reachable ✅'); }
        catch(e){ setStatus(''); setError(`Connexion impossible à ${apiBase}`); }
      }

      async function loadTokens(){
        setLoading(true); setError('');
        try{
          const r = await fetch(`${apiBase}/v1/admin/tokens?limit=${limit}&offset=${offset}`, { headers: { 'x-api-key': apiKey } });
          const j = await r.json(); if(!r.ok) throw new Error(j?.detail || r.statusText);
          setTokens(Array.isArray(j.items) ? j.items : []);
          setStatus(`Chargé: ${j.items?.length||0} token(s)`);
        }catch(e){ setError(String(e.message||e)); }
        finally{ setLoading(false); }
      }

      const [mintBody, setMintBody] = useState(() => JSON.stringify({
        product: { category:'wine', domain_id:'DOM-001', vintage_year:2024, batch_code:'BATCH-001', quantity:{ unit:'bottle', count:1200 } },
        issuance: { issued_at: new Date().toISOString(), issuer:'FoodGoov', producer_id:'DOMAINE-MASSEMBRE' }
      }, null, 2));
      const [lastMint, setLastMint] = useState(null);

      async function mint(){
        setLoading(true); setError('');
        try{
          const r = await fetch(`${apiBase}/v1/tokens`, { method:'POST', headers:{ 'Content-Type':'application/json', 'x-api-key': apiKey }, body: mintBody });
          const j = await r.json(); if(!r.ok) throw new Error(j?.detail || r.statusText);
          setLastMint(j); setStatus('Minted ✅');
        }catch(e){ setError(String(e.message||e)); }
        finally{ setLoading(false); }
      }

      return (
        <div className="space-y-6">
          <h1 className="text-2xl md:text-3xl font-semibold">FoodGoov — Mini Dashboard</h1>
          <p className="text-gray-600">Visualiser et créer des tokens. Les réglages restent sur cet appareil.</p>

          <Card>
            <div className="grid md:grid-cols-3 gap-4 items-end">
              <Field>
                <Label>API Base URL</Label>
                <Input placeholder="https://foodgoov.onrender.com" value={apiBase} onChange={e=>setApiBase(e.target.value)} />
              </Field>
              <Field>
                <Label>API Key</Label>
                <Input placeholder="FG_API_KEY" value={apiKey} onChange={e=>setApiKey(e.target.value)} />
              </Field>
              <div className="flex gap-2">
                <Button onClick={testConnection}>Test Connection</Button>
                <Button onClick={loadTokens} disabled={!apiBase || !apiKey || loading}>Load Tokens</Button>
              </div>
            </div>
            <div className="mt-2 text-sm">
              {status && <span className="text-green-700">{status}</span>}
              {error && <span className="text-red-600">{error}</span>}
            </div>
          </Card>

          <div className="grid md:grid-cols-3 gap-6">
            <Card>
              <h2 className="text-lg font-medium mb-4">Liste des tokens</h2>
              <div className="flex items-center gap-2 mb-3">
                <Label>Limit</Label>
                <Input type="number" value={limit} onChange={e=>setLimit(Number(e.target.value))} className="w-24" />
                <Label>Offset</Label>
                <Input type="number" value={offset} onChange={e=>setOffset(Number(e.target.value))} className="w-24" />
                <Button onClick={loadTokens} disabled={loading}>Refresh</Button>
              </div>
              <div className="space-y-2 max-h-96 overflow-auto">
                {tokens.map((t,i)=> (
                  <div key={t.token_id || i} className="border rounded-xl p-3 hover:bg-gray-50">
                    <div className="flex items-center justify-between gap-2">
                      <div className="font-mono text-xs truncate">{t.token_id}</div>
                      {t.token_id && <Copy text={t.token_id} />}
                    </div>
                    <div className="text-sm text-gray-600 mt-1">{t.domain_id} • {t.vintage_year} • {t.batch_code}</div>
                    <div className="text-xs text-gray-500">{prettyDate(t.issued_at)} • {t.issuer}</div>
                  </div>
                ))}
                {!tokens.length && (
                  <div className="text-sm text-gray-500">Aucun token chargé. Cliquez sur Test puis Load Tokens.</div>
                )}
              </div>
            </Card>

            <Card>
              <h2 className="text-lg font-medium mb-2">Mint (démo)</h2>
              <Textarea rows={16} value={mintBody} onChange={e=>setMintBody(e.target.value)} />
              <div className="flex items-center gap-2 mt-3">
                <Button onClick={mint} disabled={!apiBase || !apiKey || loading}>Mint token</Button>
                {lastMint?.token_id && (
                  <a className="text-sm underline" href={lastMint.qr_url} target="_blank" rel="noreferrer">Voir QR</a>
                )}
              </div>
            </Card>

            <Card>
              <h2 className="text-lg font-medium mb-2">Aide</h2>
              <ul className="list-disc ml-5 text-sm text-gray-700 space-y-1">
                <li>API publique : <code className="bg-gray-100 px-1 rounded">GET /v1/anchors/latest</code></li>
                <li>Admin list : <code className="bg-gray-100 px-1 rounded">GET /v1/admin/tokens</code> (header <code>x-api-key</code>)</li>
                <li>Mint : <code className="bg-gray-100 px-1 rounded">POST /v1/tokens</code> (body JSON + header <code>x-api-key</code>)</li>
                <li>Astuce : vos réglages sont conservés localement (localStorage).</li>
              </ul>
            </Card>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
