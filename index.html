<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FoodGoov — Dashboard</title>

  <!-- QRCode (pour le bouton Partager) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- Tailwind CDN + plugins -->
  <script>
    /* La config DOIT être définie avant le script CDN */
    tailwind = {
      config: {
        darkMode: 'class',
        theme: { extend: {} },
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- Police -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Styles simples utilitaires -->
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0b1220;color:#e6e8ec}
    .page{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:#0f172a;border:1px solid #1f2a44;border-radius:16px;padding:16px}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:10px;padding:.6rem 1rem;font-weight:600}
    .btn-primary{background:#0f172a;border:1px solid #334155}
    .btn-primary:hover{background:#111827}
    .btn-muted{background:#0b1220;border:1px solid #334155}
    .field{border:1px solid #334155;background:#0b1220;border-radius:10px;padding:.55rem .8rem}
    .label{font-size:.8rem;color:#9aa4b2}
    .tag{font-size:.7rem;color:#9aa4b2}
    .link{color:#60a5fa}
    .link:hover{text-decoration:underline}
    canvas{image-rendering:pixelated}
  </style>
</head>
<body class="min-h-screen">
  <main class="page">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-white text-black grid place-items-center text-sm font-bold">FG</div>
        <div>
          <h1 class="text-xl font-semibold">FoodGoov — Dashboard</h1>
          <div class="tag">Traçabilité • Tokens • Vérification</div>
        </div>
      </div>
      <div>
        <span class="label mr-2">Statut :</span>
        <span id="statusPill" class="inline-flex items-center gap-2 rounded-full px-3 py-1 border border-[#334155] text-xs">Hors ligne</span>
      </div>
    </header>

    <!-- Ligne 1 -->
    <section class="grid md:grid-cols-3 gap-4 mb-6">
      <!-- API Base URL -->
      <div class="card">
        <div class="label mb-2">API Base URL</div>
        <input id="apiBase" class="field w-full" placeholder="https://foodgoov.onrender.com" />
        <div class="tag mt-2">Mémorisé localement sur cet appareil.</div>
      </div>

      <!-- Session -->
      <div class="card">
        <div class="label mb-2">Session</div>
        <div id="sessionInfo" class="text-sm">—</div>
      </div>

      <!-- Actions -->
      <div class="card">
        <div class="label mb-3">Actions</div>
        <div class="flex gap-3">
          <button id="testBtn"  class="btn btn-muted"   type="button">Tester API publique</button>
          <button id="loadBtn"  class="btn btn-primary" type="button">Charger mes tokens</button>
        </div>
      </div>
    </section>

    <!-- Ligne 2 -->
    <section class="grid md:grid-cols-2 gap-4 mb-6">
      <!-- Mes tokens -->
      <div class="card">
        <div class="flex items-center justify-between">
          <div class="label">Mes tokens</div>
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
              <span class="label">Limit</span>
              <input id="listLimit" class="field w-20" value="25" />
            </div>
            <div class="flex items-center gap-2">
              <span class="label">Offset</span>
              <input id="listOffset" class="field w-20" value="0" />
            </div>
            <button id="refreshBtn" class="btn btn-muted" type="button">Refresh</button>
          </div>
        </div>
        <div id="tokensList" class="mt-3 text-sm">—</div>
      </div>

      <!-- Mint -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-300">Mint (authentifié)</h3>
          <span class="tag">POST /v1/tokens</span>
        </div>

        <textarea id="mintBody" class="field w-full h-64 font-mono text-sm">
{
  "product": {
    "category": "wine",
    "domain_id": "DOM-001",
    "vintage_year": 2024,
    "batch_code": "BATCH-001",
    "quantity": { "unit": "bottle", "count": 1200 }
  },
  "issuance": {
    "issued_at": "2025-10-22T12:00:00Z",
    "issuer": "FoodGoov",
    "producer_id": "DOMAINE-MASSEMBRE"
  }
}
        </textarea>

        <div class="mt-3 flex items-center gap-3">
          <button id="mintBtn" class="btn btn-primary" type="button">Mint token</button>
        </div>
        <div id="mintResult" class="text-sm text-gray-400 mt-2"></div>

        <!-- QR / Partage -->
        <div id="qrSection" class="hidden mt-5 border-t border-[#334155] pt-4 text-center">
          <canvas id="qrCanvas" class="mx-auto mb-2"></canvas>
          <button id="shareBtn" class="btn btn-muted text-sm" type="button">Copier</button>
          <p id="shareLink" class="text-[11px] text-gray-400 mt-2"></p>
        </div>
      </div>
    </section>

    <!-- Ligne 3 : Auth -->
    <section class="grid md:grid-cols-2 gap-4">
      <!-- Connexion -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-300 mb-3">Authentification — Connexion</h3>
        <div class="grid grid-cols-3 gap-3 items-center">
        <input id="loginEmail" class="field md:col-span-1" type="text" placeholder="Email (ex : benyamin_hadipeykani@yahoo.com)" />
        <input id="loginPassword" class="field md:col-span-1" type="password" placeholder="Mot de passe" />
          <button id="loginBtn" class="btn btn-primary md:col-span-1" type="button">Se connecter</button>
        </div>
      </div>

      <!-- Création -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-300 mb-3">Authentification — Création de compte</h3>
        <div class="grid grid-cols-4 gap-3 items-center">
          <input id="signupDisplay"  class="field md:col-span-1" placeholder="Nom producteur (affiché)" />
          <input id="signupEmail"    class="field md:col-span-1" placeholder="Email" />
          <input id="signupPassword" class="field md:col-span-1" type="password" placeholder="Mot de passe" />
          <button id="signupBtn" class="btn btn-muted md:col-span-1" type="button">Créer mon compte</button>
        </div>
      </div>
    </section>

    <footer class="max-w-7xl mx-auto px-4 py-8 text-center text-[11px] text-gray-400">
      FoodGoov garantit l’unicité cryptographique du lot et sa déclaration par le producteur / émetteur enregistré.
    </footer>
  </main>

  <!-- Script principal -->
<script>
/* ====== Utilitaires & état ====== */
const $ = (id) => document.getElementById(id);

const LS_BASE = "fg_api_base";
const LS_SESS = "fg_session_token";
const LS_NAME = "fg_session_name";

let SESSION = null; // { token, display_name, producer_id, api_key }

function getApiBase(){
  let v = ($('#apiBase')?.value || '').trim();
  if (v.endsWith('/')) v = v.slice(0,-1);
  if (!v) throw new Error("API Base URL manquante");
  return v;
}

function setStatus(online){
  const pill = $('#statusPill');
  if (!pill) return;
  pill.textContent = online ? 'En ligne' : 'Hors ligne';
}

function setSessionInfo(){
  const el = $('#sessionInfo');
  if (!el) return;
  if (!SESSION) { el.textContent = '—'; setStatus(false); return; }
  const short = SESSION.token.slice(0,12) + '…';
  el.textContent = `${SESSION.display_name} • ${short}`;
  setStatus(true);
}

function saveBaseFromInput(){
  const base = ($('#apiBase')?.value || '').trim();
  localStorage.setItem(LS_BASE, base);
}

/* ====== HTTP helpers ====== */
async function apiGET(path){
  const base = getApiBase();
  const headers = {};
  if (SESSION?.token) headers['x-session'] = SESSION.token;
  const r = await fetch(base + path, { method: 'GET', headers });
  return r;
}

async function apiPOST(path, body){
  const base = getApiBase();
  const headers = { 'Content-Type': 'application/json' };
  if (SESSION?.token) headers['x-session'] = SESSION.token;
  const r = await fetch(base + path, {
    method: 'POST',
    headers,
    body: JSON.stringify(body || {})
  });
  return r;
}

/* ====== Actions ====== */

// A) API publique
async function testPublicApi(){
  try{
    const r = await apiGET('/v1/status');
    const j = await r.json();
    setStatus(r.ok);
    alert(`Status: ${j.status} • ${j.message || ''}`);
  }catch(e){
    setStatus(false);
    alert('API indisponible');
  }
}

// B) Connexion
async function login(){
  const email = ($('#loginEmail')?.value || '').trim().toLowerCase();
  const password = $('#loginPassword')?.value || '';
  if (!email || !password) return alert('Email et mot de passe requis.');
  try{
    saveBaseFromInput();
    const r = await apiPOST('/v1/auth/login', { email, password });
    const j = await r.json();
    if (!r.ok) return alert(j.detail || 'Login échoué');
    SESSION = {
      token: j.session_token,
      display_name: j.display_name,
      producer_id: j.producer_id,
      api_key: j.api_key
    };
    // persiste
    localStorage.setItem(LS_SESS, SESSION.token);
    localStorage.setItem(LS_NAME, SESSION.display_name || '');
    setSessionInfo();
    alert('Connecté');
  }catch(e){
    alert('Erreur réseau pendant la connexion');
  }
}

// C) Création compte
async function signup(){
  const display_name = ($('#signupDisplay')?.value || '').trim();
  const email = ($('#signupEmail')?.value || '').trim().toLowerCase();
  const password = $('#signupPassword')?.value || '';
  if (!display_name || !email || !password) return alert('Champs requis manquants.');
  try{
    saveBaseFromInput();
    const r = await apiPOST('/v1/auth/signup', { display_name, email, password });
    const j = await r.json();
    if (!r.ok) return alert(j.detail || 'Création échouée');
    SESSION = {
      token: j.session_token,
      display_name: j.display_name,
      producer_id: j.producer_id,
      api_key: j.api_key
    };
    localStorage.setItem(LS_SESS, SESSION.token);
    localStorage.setItem(LS_NAME, SESSION.display_name || '');
    setSessionInfo();
    alert('Compte créé');
  }catch(e){
    alert('Erreur réseau pendant la création du compte');
  }
}

// D) Mes tokens
async function loadMyTokens(){
  const out = $('#tokensList');
  if (out) out.textContent = 'Chargement…';
  try{
    const limit  = parseInt($('#listLimit')?.value || '25', 10);
    const offset = parseInt($('#listOffset')?.value || '0', 10);
    const r = await apiGET(`/v1/admin/my-tokens?limit=${limit}&offset=${offset}`);
    const j = await r.json();
    if (!r.ok){
      out.textContent = 'Erreur: ' + (j.detail || 'Load failed');
      return;
    }
    if (!j.items?.length){
      out.textContent = 'Aucun lot.';
      return;
    }
    out.innerHTML = j.items.map(t=>{
      const q = `${t.quantity.count} ${t.quantity.unit}`;
      const when = (t.issued_at || '').replace('T',' ').replace('Z','');
      return `<div class="mb-2">
        <div class="font-semibold">${t.domain_id} • ${t.batch_code}</div>
        <div class="text-[11px] text-gray-400">${t.token_id}</div>
        <div class="text-[11px] text-gray-400">${when} • ${q}</div>
      </div>`;
    }).join('');
  }catch(e){
    if (out) out.textContent = 'Erreur réseau';
  }
}

// E) Mint token
async function mintToken(){
  const out = $('#mintResult'); if (out) out.textContent = '';
  let payload;
  try{
    payload = JSON.parse($('#mintBody')?.value || '{}');
  }catch{ return alert('JSON invalide dans le bloc Mint'); }

  try{
    const r = await apiPOST('/v1/tokens', payload);
    const j = await r.json();
    if (!r.ok){
      out.textContent = 'Erreur: ' + (j.detail || r.status);
      return;
    }
    out.textContent = '✅ Token créé : ' + j.token_id;

    // QR & partage
    const link = j.qr_url || (`https://foodgoov-dashboard.onrender.com/verify.html?token_id=${j.token_id}`);
    renderQR(link);
    $('#shareLink').textContent = link;
    $('#qrSection').classList.remove('hidden');
  }catch(e){
    out.textContent = 'Erreur réseau';
  }
}

// F) QR & partage (utilise la lib QRCode incluse dans le <head>)
function renderQR(url){
  const container = $('#qrCanvas');
  if (!container) return;
  // reset
  container.innerHTML = '';
  if (window.QRCode) {
    new QRCode(container, { text: url, width: 220, height: 220 });
  } else {
    const p = document.createElement('p');
    p.className = 'text-sm text-gray-400';
    p.textContent = url;
    container.appendChild(p);
  }
}

async function copyShareLink(){
  const url = ($('#shareLink')?.textContent || '').trim();
  if (!url) return;
  try{
    await navigator.clipboard.writeText(url);
    alert('Lien copié');
  }catch{ alert('Impossible de copier'); }
}

/* ====== Câblage des boutons ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  // Base URL depuis le storage (si présent)
  const saved = localStorage.getItem(LS_BASE);
  if (saved && $('#apiBase')) $('#apiBase').value = saved;
  $('#apiBase')?.addEventListener('change', saveBaseFromInput);

  // Restaurer session (si présente)
  const tok  = localStorage.getItem(LS_SESS);
  const name = localStorage.getItem(LS_NAME);
  if (tok){
    SESSION = { token: tok, display_name: name || 'Compte', producer_id: '', api_key: '' };
    setSessionInfo();
  } else {
    setSessionInfo();
  }

  // Brancher les clics (IDs qui existent dans TON HTML)
  [['testBtn', testPublicApi],
   ['loadBtn', loadMyTokens],
   ['refreshBtn', loadMyTokens],
   ['loginBtn', login],
   ['signupBtn', signup],
   ['mintBtn', mintToken],
   ['shareBtn', copyShareLink]
  ].forEach(([id, fn])=>{
    const el = $(id);
    if (el && typeof fn === 'function') el.addEventListener('click', fn);
  });

  // Ping initial (facultatif)
  testPublicApi().catch(()=>{});
});
</script>
  <script>
(function () {
  // === Sélecteurs ===
  const apiInput     = document.getElementById('apiBase');
  const statusPill   = document.getElementById('statusPill');
  const testBtn      = document.getElementById('testBtn');
  const loadBtn      = document.getElementById('loadBtn');

  // === Helpers ===
  function getApiBase() {
    // 1) champ > 2) localStorage > 3) valeur par défaut
    let v = (apiInput?.value || '').trim();
    if (!v) v = (localStorage.getItem('fg_api_base') || '').trim();
    if (!v) v = 'https://foodgoov.onrender.com';
    // pas de slash final
    if (v.endsWith('/')) v = v.slice(0, -1);
    return v;
  }
  function setApiBase(v) {
    if (!v) return;
    v = v.trim();
    if (v.endsWith('/')) v = v.slice(0, -1);
    if (apiInput) apiInput.value = v;
    localStorage.setItem('fg_api_base', v);
  }
  function setOnlineState(ok) {
    if (!statusPill) return;
    statusPill.textContent = ok ? 'En ligne' : 'Hors ligne';
  }
  async function ping() {
    const base = getApiBase();
    try {
      const r = await fetch(base + '/v1/status', { cache: 'no-store' });
      if (!r.ok) throw new Error('bad status');
      const j = await r.json();
      setOnlineState(true);
      return j;
    } catch (e) {
      setOnlineState(false);
      throw e;
    }
  }
  function alertBox(msg) { alert(msg); }

  // === Initialisation ===
  // Remplir le champ avec la valeur mémorisée/défaut
  setApiBase(getApiBase());

  // Tester automatiquement au chargement
  ping().catch(() => {
    // ne bloque pas l’UI, on laisse juste "Hors ligne"
  });

  // Sauvegarder quand on change l’URL API
  if (apiInput) {
    apiInput.addEventListener('change', () => {
      setApiBase(apiInput.value);
      ping().catch(() => alertBox('API indisponible'));
    });
    apiInput.addEventListener('blur', () => {
      setApiBase(apiInput.value);
    });
  }

  // Bouton "Tester API publique"
  if (testBtn) {
    testBtn.addEventListener('click', async () => {
      try {
        await ping();
        alertBox('API OK ✅');
      } catch {
        alertBox('API indisponible');
      }
    });
  }

  // Bouton "Charger mes tokens" — vérifie d’abord que l’API répond
  if (loadBtn) {
    loadBtn.addEventListener('click', async () => {
      try {
        await ping();
        // ici on appelle ensuite ta fonction existante qui charge /v1/admin/my-tokens
        // ex: loadMyTokens();
      } catch {
        alertBox('API indisponible');
      }
    });
  }
})();
</script>
  <script>
/**
 * BYPASS TEMPORAIRE : force l'URL API et logge l'erreur exacte.
 * À retirer quand tout est stable.
 */
(function () {
  const FORCED_API = "https://foodgoov.onrender.com"; // <= URL exacte SANS slash final
  const apiInput   = document.getElementById("apiBase");
  const statusPill = document.getElementById("statusPill");
  const testBtn    = document.getElementById("testBtn");

  // force l'URL dans l'UI + localStorage
  if (apiInput) apiInput.value = FORCED_API;
  try { localStorage.setItem("fg_api_base", FORCED_API); } catch {}

  function setOnline(ok){ if(statusPill){ statusPill.textContent = ok ? "En ligne" : "Hors ligne"; } }

  async function ping() {
    try {
      const r = await fetch(FORCED_API + "/v1/status", {
        method: "GET",
        mode: "cors",
        cache: "no-store",
        headers: { "Accept": "application/json" },
      });
      if (!r.ok) {
        const txt = await r.text().catch(()=>String(r.status));
        throw new Error("HTTP " + r.status + " — " + txt);
      }
      setOnline(true);
      return await r.json();
    } catch (e) {
      setOnline(false);
      alert("API indisponible\n\nDétail: " + (e && e.message ? e.message : e));
      console.error("[PING ERROR]", e);
      throw e;
    }
  }

  // test auto au chargement
  ping().catch(()=>{ /* l’alerte a déjà été affichée */ });

  // bouton “Tester API publique”
  if (testBtn) {
    testBtn.addEventListener("click", () => {
      ping().then(()=>alert("API OK ✅")).catch(()=>{});
    });
  }

  // expose pour les autres scripts (s’ils lisent window.API_BASE)
  window.API_BASE = FORCED_API;
})();
</script>
</body>
</html>
