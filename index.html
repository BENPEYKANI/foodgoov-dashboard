<!doctype html>
<html lang="fr" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FoodGoov — Dashboard</title>

  <!-- QRCode CDN (pour générer le QR du lien de vérification) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- Tailwind CDN + plugins -->
  <script>
    /* La config DOIT être définie avant le script CDN Tailwind */
    tailwind = {
      config: {
        darkMode: 'class',
        theme: { extend: {} }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- Police Inter (optionnel) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <style>
    body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .btn { @apply px-4 py-2 rounded-lg text-sm font-semibold shadow border border-gray-200; }
    .btn-primary { @apply bg-indigo-700 text-white hover:bg-indigo-800; }
    .btn-muted { @apply bg-gray-100 text-gray-800 hover:bg-gray-200; }
    .card { @apply rounded-2xl border border-gray-200 p-5 bg-white; }
    .field { @apply w-full rounded-lg border-gray-300; }
    .tag { @apply text-[11px] px-2 py-0.5 rounded-full bg-gray-100; }
  </style>
</head>
<body class="bg-gray-50 min-h-full">
  <header class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-full bg-black text-white grid place-items-center font-semibold">FG</div>
        <div>
          <h1 class="text-xl font-semibold">FoodGoov — Dashboard</h1>
          <p class="text-xs text-gray-500">Traçabilité • Tokens • Vérification</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class="text-sm text-gray-500">Statut :</span>
        <span id="statusBadge" class="text-xs px-2 py-1 rounded-full bg-gray-100">Hors ligne</span>
        <button id="connectBtn" class="btn btn-primary">Se connecter</button>
        <button id="disconnectBtn" class="btn btn-muted hidden">Se déconnecter</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-16">
    <!-- Ligne 1 -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-5">
      <!-- API Base -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-700 mb-2">API Base URL</h3>
        <input id="apiBase" class="field" placeholder="https://foodgoov.onrender.com" />
        <p class="text-[11px] text-gray-400 mt-2">Mémorisé localement sur cet appareil.</p>
      </div>

      <!-- Session -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Session</h3>
        <div id="sessionBox" class="text-sm text-gray-500">—</div>
      </div>

      <!-- Actions -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Actions</h3>
        <div class="flex gap-3 flex-wrap">
          <button id="testBtn" class="btn btn-muted">Tester API publique</button>
          <button id="loadBtn" class="btn btn-muted">Charger mes tokens</button>
        </div>
      </div>
    </section>

    <!-- Ligne 2 -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-5 mt-6">
      <!-- Mes tokens -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-700">Mes tokens</h3>
          <div class="flex items-center gap-2">
            <label class="text-xs text-gray-500">Limit</label>
            <input id="limit" class="field w-20" value="25" />
            <label class="text-xs text-gray-500">Offset</label>
            <input id="offset" class="field w-20" value="0" />
            <button class="btn btn-muted" onclick="loadMyTokens()">Refresh</button>
          </div>
        </div>
        <div id="myTokens" class="text-sm text-gray-700 border-t pt-3">—</div>
      </div>

      <!-- Mint -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-700">Mint (authentifié)</h3>
          <span class="tag">POST /v1/tokens</span>
        </div>

        <textarea id="mintBody" class="field font-mono text-sm w-full h-56">
{
  "product": {
    "category": "wine",
    "domain_id": "DOM-001",
    "vintage_year": 2024,
    "batch_code": "BATCH-001",
    "quantity": { "unit": "bottle", "count": 1200 }
  },
  "issuance": {
    "issued_at": "2025-10-22T12:00:00Z",
    "issuer": "FoodGoov",
    "producer_id": "DOMAINE-MASSEMBRE"
  }
}
        </textarea>

        <div class="mt-3 flex items-center gap-3">
          <button id="mintBtn" class="btn btn-primary">Mint token</button>
          <div id="mintResult" class="text-sm text-gray-500"></div>
        </div>

        <!-- Résultat + QR -->
        <div id="qrSection" class="hidden mt-5 border-t border-gray-200 pt-4 text-center">
          <canvas id="qrCanvas" class="mx-auto mb-2"></canvas>
          <div class="flex items-center justify-center gap-3">
            <button id="shareBtn" class="btn btn-muted text-sm">Copier le lien</button>
            <p id="shareLink" class="text-[11px] text-gray-500 break-all"></p>
          </div>
        </div>
      </div>
    </section>

    <!-- Ligne 3 : Auth -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-5 mt-6">
      <!-- Connexion -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Authentification — Connexion</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-center">
          <input id="loginEmail" class="field md:col-span-1" placeholder="Email" />
          <input id="loginPassword" class="field md:col-span-1" placeholder="Mot de passe" type="password" />
          <button id="loginBtn" class="btn btn-primary md:col-span-1">Se connecter</button>
        </div>
      </div>

      <!-- Création de compte -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Authentification — Création de compte</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-center">
          <input id="signupDisplay" class="field md:col-span-2" placeholder="Nom producteur (affiché)" />
          <input id="signupEmail" class="field md:col-span-1" placeholder="Email" />
          <input id="signupPassword" class="field md:col-span-1" placeholder="Mot de passe" type="password" />
          <button id="signupBtn" class="btn btn-muted md:col-span-4">Créer mon compte</button>
        </div>
      </div>
    </section>

    <footer class="max-w-6xl mx-auto px-4 py-10 text-center text-[11px] text-gray-400">
      FoodGoov garantit l’unicité cryptographique du lot et sa déclaration par le producteur / émetteur enregistré.
    </footer>
  </main>

  <!-- =========================
       SCRIPT PRINCIPAL
       ========================= -->
  <script>
  /* =========================
     Helpers & Etat local
     ========================= */
  const LS = {
    apiBase: "fg_api_base",
    session: "fg_session",
    apiKey: "fg_api_key",
    displayName: "fg_display_name",
  };

  function $(sel) { return document.querySelector(sel); }
  function prettyDate(iso) { try { return new Date(iso).toLocaleString(); } catch { return iso; } }

  function getApiBase() {
    const el = $("#apiBase");
    const v = (el?.value || "").trim();
    return v || localStorage.getItem(LS.apiBase) || "";
  }
  function saveApiBase() {
    const v = ($("#apiBase")?.value || "").trim();
    if (v) localStorage.setItem(LS.apiBase, v);
    // Feedback statut visuel
    $("#statusBadge").textContent = v ? "En ligne ?" : "Hors ligne";
  }

  function storeSession(data) {
    if (data?.session_token) localStorage.setItem(LS.session, data.session_token);
    if (data?.api_key)       localStorage.setItem(LS.apiKey, data.api_key);
    if (data?.display_name)  localStorage.setItem(LS.displayName, data.display_name);
    renderSessionBadge();
  }
  function clearSession() {
    localStorage.removeItem(LS.session);
    localStorage.removeItem(LS.apiKey);
    localStorage.removeItem(LS.displayName);
    renderSessionBadge();
  }
  function currentSession() { return localStorage.getItem(LS.session) || ""; }
  function currentApiKey()   { return localStorage.getItem(LS.apiKey) || ""; }

  function renderSessionBadge() {
    const s = currentSession();
    const name = localStorage.getItem(LS.displayName) || "";
    const box = $("#sessionBox");
    if (!box) return;
    if (!s) {
      box.innerHTML = "—";
      $("#connectBtn")?.classList.remove("hidden");
      $("#disconnectBtn")?.classList.add("hidden");
    } else {
      const short = s.slice(0, 10) + "…";
      box.innerHTML = `${name ? `<span class="font-semibold">${name}</span> • ` : ""}<span class="text-gray-500">${short}</span>`;
      $("#connectBtn")?.classList.add("hidden");
      $("#disconnectBtn")?.classList.remove("hidden");
    }
  }

  /* =========================
     Requêtes API
     ========================= */
  async function apiGET(path, { auth=false, params=null } = {}) {
    const base = getApiBase(); if (!base) throw new Error("API Base URL manquante");
    const url = new URL(path, base);
    if (params) Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
    const headers = { "Accept": "application/json" };
    if (auth) headers["x-session"] = currentSession();
    const r = await fetch(url.toString(), { headers });
    if (!r.ok) throw await r.json().catch(()=>({detail:`Erreur ${r.status}`}));
    return r.json();
  }

  async function apiPOST(path, body, { auth=false, includeApiKey=true } = {}) {
    const base = getApiBase(); if (!base) throw new Error("API Base URL manquante");
    const headers = { "Content-Type": "application/json", "Accept": "application/json" };
    if (auth) headers["x-session"] = currentSession();
    if (includeApiKey && currentApiKey()) headers["x-api-key"] = currentApiKey(); // toléré/ignoré suivant l’endpoint
    const r = await fetch(new URL(path, base).toString(), {
      method: "POST",
      headers,
      body: JSON.stringify(body || {})
    });
    if (!r.ok) throw await r.json().catch(()=>({detail:`Erreur ${r.status}`}));
    return r.json();
  }

  /* =========================
     UI : Status, Tokens, QR
     ========================= */
  async function testPublicAPI() {
    try {
      saveApiBase();
      const data = await apiGET("/v1/status");
      $("#statusBadge").textContent = "En ligne";
      alert(`OK • ${data.message || "API opérationnelle"}`);
    } catch (e) {
      $("#statusBadge").textContent = "Hors ligne";
      alert(`Échec : ${e.detail || e.message}`);
    }
  }

  async function loadMyTokens() {
    try {
      saveApiBase();
      const limit = ($("#limit")?.value || "25").trim();
      const offset = ($("#offset")?.value || "0").trim();
      const data = await apiGET("/v1/admin/my-tokens", { auth: true, params: { limit, offset }});
      const box = $("#myTokens");
      if (!box) return;
      if (!data?.items?.length) {
        box.innerHTML = "—";
        return;
      }
      box.innerHTML = data.items.map(t => {
        const line = `${t.domain_id} • ${t.vintage_year} • ${t.batch_code} — ${t.issuer || ""}`;
        return `<div class="py-1 text-sm flex items-center justify-between">
          <span class="truncate">${line}</span>
          <button class="text-[11px] underline" onclick="openVerify('${t.token_id}')">Voir</button>
        </div>`;
      }).join("");
    } catch (e) {
      alert(`Échec chargement : ${e.detail || e.message}`);
    }
  }

  function openVerify(tokenId) {
    const url = `${location.origin}/verify.html?token_id=${encodeURIComponent(tokenId)}`;
    window.open(url, "_blank");
  }

  async function mintToken() {
    try {
      saveApiBase();
      const raw = $("#mintBody")?.value || "{}";
      let body;
      try { body = JSON.parse(raw); }
      catch { alert("JSON non valide dans le bloc Mint."); return; }

      const out = await apiPOST("/v1/tokens", body, { auth: true, includeApiKey: !!currentApiKey() });
      const tokenId = out?.token_id;
      $("#mintResult").textContent = tokenId ? `✅ Token créé : ${tokenId}` : "Créé";

      if (tokenId) {
        await renderQR(tokenId);
        updateShareLink(tokenId);
      }
      loadMyTokens();
    } catch (e) {
      $("#mintResult").textContent = `❌ ${e.detail || e.message}`;
    }
  }

  async function renderQR(tokenId) {
    const canvas = $("#qrCanvas");
    const section = $("#qrSection");
    if (!canvas || !section) return;
    const verifyUrl = `${location.origin}/verify.html?token_id=${encodeURIComponent(tokenId)}`;
    await QRCode.toCanvas(canvas, verifyUrl, { width: 220, margin: 1 });
    section.classList.remove("hidden");
  }

  function updateShareLink(tokenId) {
    const p = $("#shareLink");
    if (!p) return;
    const verifyUrl = `${location.origin}/verify.html?token_id=${encodeURIComponent(tokenId)}`;
    p.textContent = verifyUrl;
    p.dataset.url = verifyUrl;
  }

  async function copyShareLink() {
    const p = $("#shareLink");
    if (!p?.dataset?.url) return;
    await navigator.clipboard.writeText(p.dataset.url);
    alert("Lien de vérification copié !");
  }

  /* =========================
     Auth : login / signup / logout
     ========================= */
  async function login() {
    try {
      saveApiBase();
      const email = ($("#loginEmail")?.value || "").trim();
      const password = ($("#loginPassword")?.value || "").trim();
      if (!email || !password) { alert("Email et mot de passe requis."); return; }

      const data = await apiPOST("/v1/auth/login", { email, password }, { auth:false, includeApiKey:false });
      storeSession(data);
      alert(`Connecté : ${data.display_name || email}`);
    } catch (e) {
      alert(`Connexion échouée : ${e.detail || e.message}`);
    }
  }

  async function signup() {
    try {
      saveApiBase();
      const display_name = ($("#signupDisplay")?.value || "").trim();
      const email = ($("#signupEmail")?.value || "").trim();
      const password = ($("#signupPassword")?.value || "").trim();
      if (!display_name || !email || !password) { alert("Tous les champs sont requis."); return; }

      const data = await apiPOST("/v1/auth/signup", { display_name, email, password }, { auth:false, includeApiKey:false });
      storeSession(data);
      alert(`Compte créé : ${data.display_name || display_name}`);
    } catch (e) {
      alert(`Création échouée : ${e.detail || e.message}`);
    }
  }

  function logout() {
    clearSession();
    alert("Déconnecté.");
  }

  /* =========================
     Bootstrap UI
     ========================= */
  function wireButtonsIfNeeded() {
    $("#testBtn")    && ($("#testBtn").onclick    = testPublicAPI);
    $("#loadBtn")    && ($("#loadBtn").onclick    = loadMyTokens);
    $("#loginBtn")   && ($("#loginBtn").onclick   = login);
    $("#signupBtn")  && ($("#signupBtn").onclick  = signup);
    $("#disconnectBtn") && ($("#disconnectBtn").onclick = logout);
    $("#mintBtn")    && ($("#mintBtn").onclick    = mintToken);
    $("#shareBtn")   && ($("#shareBtn").onclick   = copyShareLink);
    $("#connectBtn") && ($("#connectBtn").onclick = () => {
      document.querySelector('#loginEmail')?.scrollIntoView({behavior:'smooth', block:'center'});
    });
  }

  window.addEventListener("DOMContentLoaded", () => {
    const saved = localStorage.getItem(LS.apiBase);
    if (saved && $("#apiBase")) $("#apiBase").value = saved;
    renderSessionBadge();
    wireButtonsIfNeeded();
  });
  </script>
</body>
</html>
