<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FoodGoov — Dashboard</title>

  <!-- QRCode (pour le bouton Partager) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- Tailwind CDN + plugins -->
  <script>
    /* La config DOIT être définie avant le script CDN */
    tailwind = {
      config: {
        darkMode: 'class',
        theme: { extend: {} },
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- Police -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Styles simples utilitaires -->
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0b1220;color:#e6e8ec}
    .page{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:#0f172a;border:1px solid #1f2a44;border-radius:16px;padding:16px}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:10px;padding:.6rem 1rem;font-weight:600}
    .btn-primary{background:#0f172a;border:1px solid #334155}
    .btn-primary:hover{background:#111827}
    .btn-muted{background:#0b1220;border:1px solid #334155}
    .field{border:1px solid #334155;background:#0b1220;border-radius:10px;padding:.55rem .8rem}
    .label{font-size:.8rem;color:#9aa4b2}
    .tag{font-size:.7rem;color:#9aa4b2}
    .link{color:#60a5fa}
    .link:hover{text-decoration:underline}
    canvas{image-rendering:pixelated}
  </style>
</head>
<body class="min-h-screen">
  <main class="page">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-white text-black grid place-items-center text-sm font-bold">FG</div>
        <div>
          <h1 class="text-xl font-semibold">FoodGoov — Dashboard</h1>
          <div class="tag">Traçabilité • Tokens • Vérification</div>
        </div>
      </div>
      <div>
        <span class="label mr-2">Statut :</span>
        <span id="statusPill" class="inline-flex items-center gap-2 rounded-full px-3 py-1 border border-[#334155] text-xs">Hors ligne</span>
      </div>
    </header>

    <!-- Ligne 1 -->
    <section class="grid md:grid-cols-3 gap-4 mb-6">
      <!-- API Base URL -->
      <div class="card">
        <div class="label mb-2">API Base URL</div>
        <input id="apiBase" class="field w-full" placeholder="https://foodgoov.onrender.com" />
        <div class="tag mt-2">Mémorisé localement sur cet appareil.</div>
      </div>

      <!-- Session -->
      <div class="card">
        <div class="label mb-2">Session</div>
        <div id="sessionInfo" class="text-sm">—</div>
      </div>

      <!-- Actions -->
      <div class="card">
        <div class="label mb-3">Actions</div>
        <div class="flex gap-3">
          <button id="testBtn"  class="btn btn-muted"   type="button">Tester API publique</button>
          <button id="loadBtn"  class="btn btn-primary" type="button">Charger mes tokens</button>
        </div>
      </div>
    </section>

    <!-- Ligne 2 -->
    <section class="grid md:grid-cols-2 gap-4 mb-6">
      <!-- Mes tokens -->
      <div class="card">
        <div class="flex items-center justify-between">
          <div class="label">Mes tokens</div>
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
              <span class="label">Limit</span>
              <input id="listLimit" class="field w-20" value="25" />
            </div>
            <div class="flex items-center gap-2">
              <span class="label">Offset</span>
              <input id="listOffset" class="field w-20" value="0" />
            </div>
            <button id="refreshBtn" class="btn btn-muted" type="button">Refresh</button>
          </div>
        </div>
        <div id="tokensList" class="mt-3 text-sm">—</div>
      </div>

      <!-- Mint -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-300">Mint (authentifié)</h3>
          <span class="tag">POST /v1/tokens</span>
        </div>

        <textarea id="mintBody" class="field w-full h-64 font-mono text-sm">
{
  "product": {
    "category": "wine",
    "domain_id": "DOM-001",
    "vintage_year": 2024,
    "batch_code": "BATCH-001",
    "quantity": { "unit": "bottle", "count": 1200 }
  },
  "issuance": {
    "issued_at": "2025-10-22T12:00:00Z",
    "issuer": "FoodGoov",
    "producer_id": "DOMAINE-MASSEMBRE"
  }
}
        </textarea>

        <div class="mt-3 flex items-center gap-3">
          <button id="mintBtn" class="btn btn-primary" type="button">Mint token</button>
        </div>
        <div id="mintResult" class="text-sm text-gray-400 mt-2"></div>

        <!-- QR / Partage -->
        <div id="qrSection" class="hidden mt-5 border-t border-[#334155] pt-4 text-center">
          <canvas id="qrCanvas" class="mx-auto mb-2"></canvas>
          <button id="shareBtn" class="btn btn-muted text-sm" type="button">Copier</button>
          <button id="downloadQRBtn" class="btn btn-muted text-sm" type="button">Télécharger le QR</button>
          <p id="shareLink" class="text-[11px] text-gray-400 mt-2"></p>
        </div>
      </div>
    </section>

    <!-- Ligne 3 : Auth -->
    <section class="grid md:grid-cols-2 gap-4">
      <!-- Connexion -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-300 mb-3">Authentification — Connexion</h3>
        <div class="grid grid-cols-3 gap-3 items-center">
        <input id="loginEmail" class="field md:col-span-1" type="text" placeholder="Email (ex : benyamin_hadipeykani@yahoo.com)" />
        <input id="loginPassword" class="field md:col-span-1" type="password" placeholder="Mot de passe" />
          <button id="loginBtn" class="btn btn-primary md:col-span-1" type="button">Se connecter</button>
        </div>
      </div>

      <!-- Création -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-300 mb-3">Authentification — Création de compte</h3>
        <div class="grid grid-cols-4 gap-3 items-center">
          <input id="signupDisplay"  class="field md:col-span-1" placeholder="Nom producteur (affiché)" />
          <input id="signupEmail"    class="field md:col-span-1" placeholder="Email" />
          <input id="signupPassword" class="field md:col-span-1" type="password" placeholder="Mot de passe" />
          <button id="signupBtn" class="btn btn-muted md:col-span-1" type="button">Créer mon compte</button>
        </div>
      </div>
    </section>

    <footer class="max-w-7xl mx-auto px-4 py-8 text-center text-[11px] text-gray-400">
      FoodGoov garantit l’unicité cryptographique du lot et sa déclaration par le producteur / émetteur enregistré.
    </footer>
  </main>

  <!-- Script principal -->
<script>
(function () {
  // ------- helpers UI -------
  const $ = (id) => document.getElementById(id);
  const apiInput     = $("apiBase");
  const statusPill   = $("statusPill");
  const testBtn      = $("testBtn");
  const loadBtn      = $("loadBtn");
  const refreshBtn   = $("refreshBtn");
  const listLimit    = $("listLimit");
  const listOffset   = $("listOffset");
  const tokensList   = $("tokensList");
  const loginEmail   = $("loginEmail");
  const loginPass    = $("loginPassword");
  const loginBtn     = $("loginBtn");
  const signupDisplay= $("signupDisplay");
  const signupEmail  = $("signupEmail");
  const signupPass   = $("signupPassword");
  const signupBtn    = $("signupBtn");
  const mintBodyEl   = $("mintBody");
  const mintBtn      = $("mintBtn");
  const mintResult   = $("mintResult");
  const sessionInfo  = $("sessionInfo");
  const qrSection    = $("qrSection");
  const qrCanvas     = $("qrCanvas");
  const shareBtn     = $("shareBtn");
  const shareLink    = $("shareLink");

  // ------- persistence -------
  function getApiBase() {
    let v = (apiInput?.value || "").trim();
    if (!v) try { v = localStorage.getItem("fg_api_base") || ""; } catch {}
    v = v.replace(/\/+$/, ""); // retire slash final
    if (apiInput) apiInput.value = v;
    try { localStorage.setItem("fg_api_base", v); } catch {}
    return v;
  }
  if (apiInput && !apiInput.value) {
    try { apiInput.value = localStorage.getItem("fg_api_base") || "https://foodgoov.onrender.com"; } catch {}
  }
  apiInput?.addEventListener("change", getApiBase);

  function setStatus(ok) {
    if (!statusPill) return;
    statusPill.textContent = ok ? "En ligne" : "Hors ligne";
  }
  function alertMsg(msg){ window.alert(msg); }

  // ------- session token en mémoire -------
  let SESSION = null; // {producer_id, display_name, session_token, api_key}
  try {
    const raw = localStorage.getItem("fg_session");
    if (raw) SESSION = JSON.parse(raw);
  } catch {}

  function saveSession(s) {
    SESSION = s;
    try { localStorage.setItem("fg_session", JSON.stringify(s)); } catch {}
    if (sessionInfo) {
      sessionInfo.textContent = s ? (s.display_name + " · " + s.session_token.slice(0, 8) + "…") : "—";
    }
  }
  saveSession(SESSION); // reflète l’état au chargement

  // ------- appels API -------
  async function ping() {
    const base = getApiBase();
    try {
      const r = await fetch(base + "/v1/status", { method: "GET", mode: "cors", cache: "no-store" });
      if (!r.ok) throw new Error("HTTP " + r.status + " " + (await r.text()));
      setStatus(true);
      return true;
    } catch (e) {
      setStatus(false);
      alertMsg("API indisponible\n\n" + (e.message || e));
      return false;
    }
  }

  async function doLogin() {
    const base = getApiBase();
    const email = (loginEmail?.value || "").trim().toLowerCase();
    const pw    = (loginPass?.value || "");
    if (!email || !pw) { alertMsg("Email et mot de passe requis."); return; }
    const ok = await ping(); if (!ok) return;

    try {
      const r = await fetch(base + "/v1/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password: pw })
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data.detail || JSON.stringify(data));
      // attend { producer_id, api_key, session_token, display_name }
      saveSession(data);
      alertMsg("Connecté : " + data.display_name);
    } catch (e) {
      alertMsg("Connexion échouée : " + (e.message || e));
    }
  }

  async function doSignup() {
    const base = getApiBase();
    const display = (signupDisplay?.value || "").trim();
    const email   = (signupEmail?.value || "").trim().toLowerCase();
    const pw      = (signupPass?.value || "");
    if (!display || !email || !pw) { alertMsg("Tous les champs sont requis."); return; }
    const ok = await ping(); if (!ok) return;

    try {
      const r = await fetch(base + "/v1/auth/signup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ display_name: display, email, password: pw })
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data.detail || JSON.stringify(data));
      saveSession(data);
      alertMsg("Compte créé : " + data.display_name);
    } catch (e) {
      alertMsg("Création échouée : " + (e.message || e));
    }
  }

  async function loadMyTokens() {
    const base = getApiBase();
    const ok = await ping(); if (!ok) return;
    if (!SESSION?.session_token) { alertMsg("Connecte-toi d’abord."); return; }

    const lim = parseInt(listLimit?.value || "25", 10) || 25;
    const off = parseInt(listOffset?.value || "0", 10) || 0;

    try {
      const r = await fetch(`${base}/v1/admin/my-tokens?limit=${lim}&offset=${off}`, {
        method: "GET",
        headers: { "x-session": SESSION.session_token }
      });
      const data = await r.json();
      if (!r.ok) throw new Error(data.detail || JSON.stringify(data));
      const items = data.items || [];
      tokensList.innerHTML = items.length
        ? items.map(t => `• <code>${t.token_id}</code> — ${t.category} / ${t.domain_id} / ${t.vintage_year} (${t.quantity.count} ${t.quantity.unit})`).join("<br>")
        : "—";
    } catch (e) {
      tokensList.innerHTML = "Erreur: " + (e.message || e);
    }
  }

  async function doMint() {
  const base = (document.getElementById('apiBase').value || '').trim().replace(/\/+$/, '');
  const out = document.getElementById('mintResult');
  out.textContent = '';
  if (!base) { alert('API Base URL manquante'); return; }

  // ✅ récupère la session depuis le stockage local
  let sess = null;
  try {
    const raw = localStorage.getItem('fg_session');
    if (raw) sess = JSON.parse(raw);
  } catch {}
  const token = sess?.session_token;
  if (!token) { alert('Connecte-toi d’abord'); return; }

  // ✅ prépare le JSON du token
  let payload;
  try { payload = JSON.parse(document.getElementById('mintBody').value); }
  catch { alert('JSON invalide dans le bloc Mint'); return; }

  try {
    const r = await fetch(base + '/v1/tokens', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-session': token
      },
      body: JSON.stringify(payload)
    });

    const text = await r.text();
    let data = {};
    try { data = JSON.parse(text); } catch { data = { detail: text }; }

    if (!r.ok) {
      out.textContent = `❌ ${r.status} — ${data.detail || text}`;
      alert(`Mint échoué:\n${r.status} — ${data.detail || text}`);
      return;
    }

    // ✅ Succès
    out.textContent = `✅ Token créé: ${data.token_id}`;
    const link = data.qr_url || (`https://foodgoov-dashboard.onrender.com/verify.html?token_id=${data.token_id}`);

    document.getElementById('qrSection').classList.remove('hidden');
    document.getElementById('shareLink').textContent = link;

    if (window.QRCode) {
      const canvas = document.getElementById('qrCanvas');
      canvas.innerHTML = '';
      QRCode.toCanvas(canvas, link);
    }

  } catch (e) {
    out.textContent = `❌ Erreur réseau — ${e.message || e}`;
  }
}

  // ------- bind des boutons -------
  testBtn    && (testBtn.onclick    = () => ping().then(ok => ok && alertMsg("API OK ✅")));
  loadBtn    && (loadBtn.onclick    = loadMyTokens);
  refreshBtn && (refreshBtn.onclick = loadMyTokens);
  loginBtn   && (loginBtn.onclick   = doLogin);
  signupBtn  && (signupBtn.onclick  = doSignup);
  mintBtn    && (mintBtn.onclick    = doMint);

  // Ping auto au chargement
  ping();
})();
</script>
</body>
</html>
