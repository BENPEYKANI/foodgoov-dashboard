<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FoodGoov — Dashboard</title>
<!-- Tailwind full CDN with plugins -->
<script src="https://cdn.tailwindcss.com/3.4.3"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {},
    },
    plugins: [tailwindcss.forms, tailwindcss.typography],
  };
</script>
<style>
  body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background-color: #f9fafb; }
  input, textarea, button { outline: none; }
</style>
<link href="https://cdn.jsdelivr.net/npm/@tailwindcss/forms@0.5.7/dist/forms.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@tailwindcss/typography@0.5.10/dist/typography.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto}
    .btn{ @apply px-4 py-2 rounded-xl text-sm font-semibold shadow hover:shadow-md transition;}
    .btn-primary{ @apply bg-black text-white;}
    .btn-muted{ @apply bg-gray-100;}
    .card{ @apply rounded-2xl border border-gray-200 p-4 bg-white;}
    .field{ @apply w-full border border-gray-300 rounded-xl px-3 py-2 text-sm;}
    .label{ @apply text-xs font-medium text-gray-600;}
    .tag{ @apply text-[11px] px-2 py-0.5 rounded-full bg-gray-100;}
    .link{ @apply text-blue-600 hover:underline;}
  </style>
  <style>
  body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  input, textarea, button { outline: none; }
</style>
</head>
<body class="bg-gray-50">
  <div class="max-w-6xl mx-auto p-4 md:p-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-black text-white grid place-items-center font-bold">FG</div>
        <div>
          <div class="font-semibold text-lg">FoodGoov — Dashboard</div>
          <div class="text-xs text-gray-500">Traçabilité • Tokens • Vérification</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <span id="authStatus" class="tag">Hors ligne</span>
        <button id="btnOpenAuth" class="btn btn-muted">Se connecter</button>
        <button id="btnLogout" class="btn btn-muted hidden">Se déconnecter</button>
      </div>
    </div>

    <!-- Config (API URL) -->
    <div class="grid md:grid-cols-3 gap-4 mb-6">
      <div class="card">
        <div class="label mb-1">API Base URL</div>
        <input id="apiBase" class="field" value="https://foodgoov.onrender.com" />
        <div class="mt-2 text-[11px] text-gray-500">Garde en mémoire dans cet appareil.</div>
      </div>

      <div class="card md:col-span-2">
        <div class="flex items-center justify-between">
          <div>
            <div class="label mb-1">Session</div>
            <div id="sessionPreview" class="text-sm text-gray-800 break-all">—</div>
          </div>
          <div class="flex gap-2">
            <button id="btnTestPublic" class="btn btn-muted">Tester API publique</button>
            <button id="btnLoadMine" class="btn btn-primary">Charger mes tokens</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main -->
    <div class="grid md:grid-cols-3 gap-4">
      <!-- Mes tokens -->
      <div class="card md:col-span-1">
        <div class="font-semibold mb-3">Mes tokens</div>
        <div class="flex items-center gap-2 mb-3">
          <label class="label">Limit</label>
          <input id="limit" type="number" class="field w-24" value="25" />
          <label class="label">Offset</label>
          <input id="offset" type="number" class="field w-24" value="0" />
          <button id="btnRefreshMine" class="btn btn-muted">Refresh</button>
        </div>
        <div id="mine" class="space-y-2 max-h-[420px] overflow-auto text-sm"></div>
      </div>

      <!-- Mint -->
      <div class="card md:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <div class="font-semibold">Mint (authentifié)</div>
          <span class="tag">POST /v1/tokens</span>
        </div>
        <textarea id="mintBody" class="field h-56">
{
  "product": {
    "category": "wine",
    "domain_id": "DOM-001",
    "vintage_year": 2024,
    "batch_code": "BATCH-001",
    "quantity": { "unit": "bottle", "count": 1200 }
  },
  "issuance": {
    "issued_at": "2025-10-30T14:00:00Z",
    "issuer": "FoodGoov",
    "producer_id": "DOMAINE-DE-MASSEMBRE"
  }
}
        </textarea>
        <div class="flex items-center gap-2 mt-3">
          <button id="btnMint" class="btn btn-primary">Mint token</button>
          <div id="mintResult" class="text-sm text-gray-700"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="authModal" class="fixed inset-0 bg-black/40 hidden">
    <div class="max-w-md mx-auto mt-24 card">
      <div class="flex items-center justify-between mb-2">
        <div class="font-semibold">Authentification</div>
        <button id="btnCloseAuth" class="text-gray-500">✕</button>
      </div>

      <div class="grid grid-cols-2 gap-2 mb-3">
        <button id="tabLogin"  class="btn btn-muted">Connexion</button>
        <button id="tabSignup" class="btn btn-muted">Créer un compte</button>
      </div>

      <div id="paneLogin" class="space-y-2">
        <div>
          <div class="label mb-1">Email</div>
          <input id="loginEmail" class="field" placeholder="toi@example.com" />
        </div>
        <div>
          <div class="label mb-1">Mot de passe</div>
          <input id="loginPassword" type="password" class="field" placeholder="••••••••" />
        </div>
        <button id="btnDoLogin" class="btn btn-primary w-full">Se connecter</button>
      </div>

      <div id="paneSignup" class="space-y-2 hidden">
        <div>
          <div class="label mb-1">Nom producteur (affiché)</div>
          <input id="signupDisplay" class="field" placeholder="Domaine de Massembre" />
        </div>
        <div>
          <div class="label mb-1">Email</div>
          <input id="signupEmail" class="field" placeholder="toi@example.com" />
        </div>
        <div>
          <div class="label mb-1">Mot de passe</div>
          <input id="signupPassword" type="password" class="field" placeholder="MotDePasse!Fort" />
        </div>
        <button id="btnDoSignup" class="btn btn-primary w-full">Créer mon compte</button>
      </div>
      <div id="authMsg" class="text-sm text-gray-700 mt-2"></div>
    </div>
  </div>

  <script>
    // ——— State helpers
    const $ = (s)=>document.querySelector(s);
    const ls = {
      get k(){ return localStorage.getItem("fg_session") || ""; },
      set k(v){ localStorage.setItem("fg_session", v||""); },
      get api(){ return localStorage.getItem("fg_api") || "https://foodgoov.onrender.com"; },
      set api(v){ localStorage.setItem("fg_api", v||""); },
    };

    // ——— UI init
    const apiBase = $("#apiBase"); apiBase.value = ls.api;
    const authStatus = $("#authStatus");
    const sessionPreview = $("#sessionPreview");
    const btnOpenAuth = $("#btnOpenAuth");
    const btnLogout = $("#btnLogout");
    const authModal = $("#authModal");
    const tabLogin  = $("#tabLogin");
    const tabSignup = $("#tabSignup");
    const paneLogin = $("#paneLogin");
    const paneSignup= $("#paneSignup");
    const authMsg = $("#authMsg");

    function setOnline(online){
      authStatus.textContent = online ? "Connecté" : "Hors ligne";
      authStatus.className = "tag " + (online ? "bg-green-100 text-green-700":"");
      btnOpenAuth.classList.toggle("hidden", online);
      btnLogout.classList.toggle("hidden", !online);
      sessionPreview.textContent = ls.k ? ls.k : "—";
    }

    function saveApi(){ ls.api = apiBase.value.trim(); }
    apiBase.addEventListener("change", saveApi);

    // ——— Modal
    btnOpenAuth.onclick = ()=>{ authModal.classList.remove("hidden"); authMsg.textContent=""; };
    $("#btnCloseAuth").onclick = ()=> authModal.classList.add("hidden");
    tabLogin.onclick  = ()=>{ paneLogin.classList.remove("hidden"); paneSignup.classList.add("hidden"); };
    tabSignup.onclick = ()=>{ paneSignup.classList.remove("hidden"); paneLogin.classList.add("hidden"); };

    // ——— Calls
    async function http(method, path, body, {auth=false, sessionHeader="x-session"}={}){
      const url = ls.api + path;
      const headers = { "content-type":"application/json" };
      if(auth && ls.k){ headers[sessionHeader] = ls.k; }
      const res = await fetch(url, { method, headers, body: body?JSON.stringify(body):undefined });
      const json = await res.json().catch(()=>({}));
      if(!res.ok) throw new Error(json.detail || res.statusText || "Erreur");
      return json;
    }

    // ——— Auth actions
    $("#btnDoSignup").onclick = async ()=>{
      try{
        const email = $("#signupEmail").value.trim();
        const password = $("#signupPassword").value.trim();
        const display_name = $("#signupDisplay").value.trim();
        const r = await http("POST","/v1/auth/signup",{email,password,display_name});
        ls.k = r.session_token; setOnline(true);
        authMsg.textContent = "Compte créé. Connecté en session.";
      }catch(e){ authMsg.textContent = "Signup: " + e.message; }
    };

    $("#btnDoLogin").onclick = async ()=>{
      try{
        const email = $("#loginEmail").value.trim();
        const password = $("#loginPassword").value.trim();
        const r = await http("POST","/v1/auth/login",{email,password});
        ls.k = r.session_token; setOnline(true);
        authMsg.textContent = "Connecté.";
      }catch(e){ authMsg.textContent = "Login: " + e.message; }
    };

    btnLogout.onclick = ()=>{
      ls.k = ""; setOnline(false);
    };

    // ——— Public test
    $("#btnTestPublic").onclick = async ()=>{
      try{
        const r = await http("GET","/v1/anchors/latest");
        alert("API OK (public).");
      }catch(e){ alert("Échec: " + e.message); }
    };

    // ——— My tokens
    const mineEl = $("#mine");
    async function loadMine(){
      try{
        const limit = parseInt($("#limit").value||"25",10);
        const offset= parseInt($("#offset").value||"0",10);
        const r = await http("GET", `/v1/admin/my-tokens?limit=${limit}&offset=${offset}`, null, {auth:true});
        mineEl.innerHTML = r.items.map(t => `
          <div class="border border-gray-200 rounded-xl p-3">
            <div class="text-xs text-gray-500">${t.domain_id} • ${t.vintage_year} • ${t.batch_code}</div>
            <div class="mt-1 flex items-center justify-between">
              <div class="font-medium">${t.category} · ${t.quantity.count} ${t.quantity.unit}</div>
              <a class="link text-sm" href="/verify.html?token_id=${t.token_id}" target="_blank">Voir QR</a>
            </div>
          </div>
        `).join("") || `<div class="text-sm text-gray-500">Aucun token.</div>`;
      }catch(e){
        mineEl.innerHTML = `<div class="text-sm text-red-600">Erreur: ${e.message}</div>`;
      }
    }
    $("#btnLoadMine").onclick = loadMine;
    $("#btnRefreshMine").onclick = loadMine;

    // ——— Mint (auth)
    $("#btnMint").onclick = async ()=>{
      const out = $("#mintResult");
      try{
        const body = JSON.parse($("#mintBody").value);
        const r = await http("POST","/v1/tokens", body, {auth:true});
        out.innerHTML = `
          <span class="tag bg-green-100 text-green-700">Minted</span>
          <a class="link ml-2" target="_blank" href="/verify.html?token_id=${r.token_id}">Voir</a>
        `;
        await loadMine();
      }catch(e){
        out.innerHTML = `<span class="text-red-600">${e.message}</span>`;
      }
    };

    // ——— Boot
    setOnline(!!ls.k);
    if(ls.k) loadMine();
  </script>
</body>
</html>
