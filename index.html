<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FoodGoov ‚Äî Dashboard</title>

  <!-- QRCode (pour le bouton Partager) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- Tailwind CDN + plugins -->
  <script>
    /* La config DOIT √™tre d√©finie avant le script CDN */
    tailwind = {
      config: {
        darkMode: 'class',
        theme: { extend: {} },
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- Police -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Styles simples utilitaires -->
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0b1220;color:#e6e8ec}
    .page{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:#0f172a;border:1px solid #1f2a44;border-radius:16px;padding:16px}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:10px;padding:.6rem 1rem;font-weight:600}
    .btn-primary{background:#0f172a;border:1px solid #334155}
    .btn-primary:hover{background:#111827}
    .btn-muted{background:#0b1220;border:1px solid #334155}
    .field{border:1px solid #334155;background:#0b1220;border-radius:10px;padding:.55rem .8rem}
    .label{font-size:.8rem;color:#9aa4b2}
    .tag{font-size:.7rem;color:#9aa4b2}
    .link{color:#60a5fa}
    .link:hover{text-decoration:underline}
    canvas{image-rendering:pixelated}
  </style>
</head>
<body class="min-h-screen">
  <main class="page">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-white text-black grid place-items-center text-sm font-bold">FG</div>
        <div>
          <h1 class="text-xl font-semibold">FoodGoov ‚Äî Dashboard</h1>
          <div class="tag">Tra√ßabilit√© ‚Ä¢ Tokens ‚Ä¢ V√©rification</div>
        </div>
      </div>
      <div>
        <span class="label mr-2">Statut :</span>
        <span id="statusPill" class="inline-flex items-center gap-2 rounded-full px-3 py-1 border border-[#334155] text-xs">Hors ligne</span>
      </div>
    </header>

    <!-- Ligne 1 -->
    <section class="grid md:grid-cols-3 gap-4 mb-6">
      <!-- API Base URL -->
      <div class="card">
        <div class="label mb-2">API Base URL</div>
        <input id="apiBase" class="field w-full" placeholder="https://foodgoov.onrender.com" />
        <div class="tag mt-2">M√©moris√© localement sur cet appareil.</div>
      </div>

      <!-- Session -->
      <div class="card">
        <div class="label mb-2">Session</div>
        <div id="sessionInfo" class="text-sm">‚Äî</div>
      </div>

      <!-- Actions -->
      <div class="card">
        <div class="label mb-3">Actions</div>
        <div class="flex gap-3">
          <button id="testBtn"  class="btn btn-muted"   type="button">Tester API publique</button>
          <button id="loadBtn"  class="btn btn-primary" type="button">Charger mes tokens</button>
        </div>
      </div>
    </section>

    <!-- Ligne 2 -->
    <section class="grid md:grid-cols-2 gap-4 mb-6">
      <!-- Mes tokens -->
      <div class="card">
        <div class="flex items-center justify-between">
          <div class="label">Mes tokens</div>
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
              <span class="label">Limit</span>
              <input id="listLimit" class="field w-20" value="25" />
            </div>
            <div class="flex items-center gap-2">
              <span class="label">Offset</span>
              <input id="listOffset" class="field w-20" value="0" />
            </div>
            <button id="refreshBtn" class="btn btn-muted" type="button">Refresh</button>
          </div>
        </div>
        <div id="tokensList" class="mt-3 text-sm">‚Äî</div>
      </div>

      <!-- Mint -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-300">Mint (authentifi√©)</h3>
          <span class="tag">POST /v1/tokens</span>
        </div>

        <textarea id="mintBody" class="field w-full h-64 font-mono text-sm">
{
  "product": {
    "category": "wine",
    "domain_id": "DOM-001",
    "vintage_year": 2024,
    "batch_code": "BATCH-001",
    "quantity": { "unit": "bottle", "count": 1200 }
  },
  "issuance": {
    "issued_at": "2025-10-22T12:00:00Z",
    "issuer": "FoodGoov",
    "producer_id": "DOMAINE-MASSEMBRE"
  }
}
        </textarea>

        <div class="mt-3 flex items-center gap-3">
          <button id="mintBtn" class="btn btn-primary" type="button">Mint token</button>
        </div>
        <div id="mintResult" class="text-sm text-gray-400 mt-2"></div>

        <!-- QR / Partage -->
        <div id="qrSection" class="hidden mt-5 border-t border-[#334155] pt-4 text-center">
          <canvas id="qrCanvas" class="mx-auto mb-2"></canvas>
          <button id="shareBtn" class="btn btn-muted text-sm" type="button">Copier</button>
          <p id="shareLink" class="text-[11px] text-gray-400 mt-2"></p>
        </div>
      </div>
    </section>

    <!-- Ligne 3 : Auth -->
    <section class="grid md:grid-cols-2 gap-4">
      <!-- Connexion -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-300 mb-3">Authentification ‚Äî Connexion</h3>
        <div class="grid grid-cols-3 gap-3 items-center">
          <input id="loginEmail"    class="field md:col-span-1" placeholder="Email" />
          <input id="loginPassword" class="field md:col-span-1" type="password" placeholder="Mot de passe" />
          <button id="loginBtn" class="btn btn-primary md:col-span-1" type="button">Se connecter</button>
        </div>
      </div>

      <!-- Cr√©ation -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-300 mb-3">Authentification ‚Äî Cr√©ation de compte</h3>
        <div class="grid grid-cols-4 gap-3 items-center">
          <input id="signupDisplay"  class="field md:col-span-1" placeholder="Nom producteur (affich√©)" />
          <input id="signupEmail"    class="field md:col-span-1" placeholder="Email" />
          <input id="signupPassword" class="field md:col-span-1" type="password" placeholder="Mot de passe" />
          <button id="signupBtn" class="btn btn-muted md:col-span-1" type="button">Cr√©er mon compte</button>
        </div>
      </div>
    </section>

    <footer class="max-w-7xl mx-auto px-4 py-8 text-center text-[11px] text-gray-400">
      FoodGoov garantit l‚Äôunicit√© cryptographique du lot et sa d√©claration par le producteur / √©metteur enregistr√©.
    </footer>
  </main>

  <!-- Script principal -->
<script>
/* ========= Helpers de base ========= */

const $ = (id) => document.getElementById(id);

// M√©moire locale (dans la page) pour la session
let SESSION = null; // { token, display_name, producer_id }

// Lire et m√©moriser l'API base URL depuis le champ (sans slash final)
function getApiBase() {
  let url = ($('#apiBase').value || '').trim();
  if (url.endsWith('/')) url = url.slice(0, -1);
  return url;
}

// Met √† jour l‚Äôaffichage du statut (online/offline)
function setStatus(online) {
  const pill = $('#statusPill');
  pill.textContent = online ? 'En ligne' : 'Hors ligne';
}

// Met √† jour le bloc Session
function setSessionInfo() {
  const el = $('#sessionInfo');
  if (!SESSION) {
    el.textContent = '‚Äî';
  } else {
    const short = SESSION.token.slice(0, 12) + '‚Ä¶';
    el.textContent = `${SESSION.display_name} ‚Ä¢ ${short}`;
  }
}

/* ========= Appels API ========= */

async function apiGET(path, opts = {}) {
  const base = getApiBase();
  const headers = Object.assign({}, opts.headers || {});
  if (SESSION?.token) headers['x-session'] = SESSION.token;
  const res = await fetch(base + path, {
    method: 'GET',
    headers
  });
  return res;
}

async function apiPOST(path, body, opts = {}) {
  const base = getApiBase();
  const headers = Object.assign(
    { 'content-type': 'application/json' },
    opts.headers || {}
  );
  if (SESSION?.token) headers['x-session'] = SESSION.token;
  const res = await fetch(base + path, {
    method: 'POST',
    headers,
    body: JSON.stringify(body)
  });
  return res;
}

/* ========= Actions ========= */

// A. Tester API publique
async function testPublicApi() {
  try {
    const r = await apiGET('/v1/status');
    setStatus(r.ok);
    const j = await r.json();
    alert(`Status: ${j.status}\nMessage: ${j.message || ''}`);
  } catch (e) {
    setStatus(false);
    alert('API indisponible.');
  }
}

// B. Connexion
async function login() {
  const email = ($('#loginEmail').value || '').trim();
  const password = $('#loginPassword').value || '';
  if (!email || !password) return alert('Email et mot de passe requis.');

  try {
    const r = await apiPOST('/v1/auth/login', { email, password });
    const j = await r.json();
    if (!r.ok) return alert(j.detail || 'Login √©chou√©');

    SESSION = {
      token: j.session_token,             // fgsess_‚Ä¶
      display_name: j.display_name,
      producer_id: j.producer_id,
      api_key: j.api_key
    };
    setSessionInfo();
    alert(`Connect√© : ${j.display_name}`);
  } catch (e) {
    alert('Erreur r√©seau pendant la connexion.');
  }
}

// C. Cr√©ation de compte
async function signup() {
  const display_name = ($('#signupDisplay').value || '').trim();
  const email = ($('#signupEmail').value || '').trim();
  const password = $('#signupPassword').value || '';
  if (!display_name || !email || !password) {
    return alert('Nom, email et mot de passe sont requis.');
  }
  try {
    const r = await apiPOST('/v1/auth/signup', { display_name, email, password });
    const j = await r.json();
    if (!r.ok) return alert(j.detail || 'Cr√©ation √©chou√©e');

    SESSION = {
      token: j.session_token,
      display_name: j.display_name,
      producer_id: j.producer_id,
      api_key: j.api_key
    };
    setSessionInfo();
    alert(`Compte cr√©√© : ${j.display_name}`);
  } catch (e) {
    alert('Erreur r√©seau pendant la cr√©ation de compte.');
  }
}

// D. Charger mes tokens
async function loadMyTokens() {
  const limit = parseInt($('#listLimit').value || '25', 10);
  const offset = parseInt($('#listOffset').value || '0', 10);
  const out = $('#tokensList');
  out.textContent = 'Chargement‚Ä¶';

  try {
    const r = await apiGET(`/v1/admin/my-tokens?limit=${limit}&offset=${offset}`);
    const j = await r.json();
    if (!r.ok) {
      out.textContent = `Erreur: ${j.detail || 'Load failed'}`;
      return;
    }
    if (!j.items || j.items.length === 0) {
      out.textContent = 'Aucun lot.';
      return;
    }
    // Affichage simple
    out.innerHTML = j.items.map(t => {
      const q = `${t.quantity.count} ${t.quantity.unit}`;
      const when = (t.issued_at || '').replace('T', ' ').replace('Z', '');
      return `<div class="mb-2">
        <div class="font-semibold">${t.domain_id} ‚Ä¢ ${t.batch_code}</div>
        <div class="text-[11px] text-gray-400">${t.token_id}</div>
        <div class="text-[11px] text-gray-400">${when} ‚Ä¢ ${q}</div>
      </div>`;
    }).join('');
  } catch (e) {
    $('#tokensList').textContent = 'Erreur r√©seau.';
  }
}

// E. Mint token
async function mintToken() {
  const bodyRaw = $('#mintBody').value;
  const out = $('#mintResult');
  out.textContent = '';
  let payload;
  try {
    payload = JSON.parse(bodyRaw);
  } catch (e) {
    return alert('JSON invalide dans le bloc Mint.');
  }
  try {
    const r = await apiPOST('/v1/tokens', payload);
    const j = await r.json();
    if (!r.ok) {
      out.textContent = 'Erreur: ' + (j.detail || 'Load failed');
      return;
    }
    out.textContent = `‚úÖ Token cr√©√© : ${j.token_id}`;
    // QR
    renderQR(j.token_id);
    // Lien partage
    const link = `https://foodgoov-dashboard.onrender.com/verify.html?token_id=${j.token_id}`;
    $('#shareLink').textContent = link;
    $('#qrSection').classList.remove('hidden');
  } catch (e) {
    out.textContent = 'Erreur r√©seau.';
  }
}

// F. G√©n√©rer le QR
function renderQR(tokenId) {
  const canvas = $('#qrCanvas');
  const url = `https://foodgoov-dashboard.onrender.com/verify.html?token_id=${tokenId}`;
  // La lib QRCode est charg√©e depuis le CDN <script src=".../qrcode.min.js">
  if (window.QRCode) {
    const qr = new QRCode(canvas, { width: 200, height: 200 });
    // La lib selon versions accepte canvas, ou il faut appeler makeCode sur un √©l√©ment DOM.
    // Astuce robuste :
    canvas.innerHTML = '';                 // reset √©ventuel
    new QRCode(canvas, { text: url, width: 200, height: 200 });
  } else {
    // fallback
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#999';
    ctx.fillRect(0,0,200,200);
    ctx.fillStyle = '#000';
    ctx.fillText('QR lib absente', 40, 100);
  }
}

// G. Copier le lien de partage
async function copyShareLink() {
  const text = ($('#shareLink').textContent || '').trim();
  if (!text) return;
  try {
    await navigator.clipboard.writeText(text);
    alert('Lien copi√© dans le presse-papier.');
  } catch {
    alert('Impossible de copier (permissions navigateur).');
  }
}

/* ========= Branchement des boutons ========= */

document.addEventListener('DOMContentLoaded', () => {
  // Statut initial : tentons un ping
  testPublicApi().catch(() => {});

  const wiring = [
    ['testBtn',    testPublicApi],
    ['loadBtn',    loadMyTokens],
    ['refreshBtn', loadMyTokens],
    ['loginBtn',   login],
    ['signupBtn',  signup],
    ['mintBtn',    mintToken],
    ['shareBtn',   copyShareLink],
  ];
  wiring.forEach(([id, fn]) => {
    const el = $(id);
    if (el && typeof fn === 'function') el.addEventListener('click', fn);
  });

  // Restaure √©ventuellement l‚ÄôAPI Base URL enregistr√©e (si tu utilises localStorage plus tard)
  setSessionInfo();
});
</script>
  <script>
/* üîî Smoke test minimal : prouve que le JS s'ex√©cute et que les boutons existent */
alert("‚úÖ JS bien charg√© (smoke test)");

const ids = ["testBtn","loadBtn","refreshBtn","loginBtn","signupBtn","mintBtn","shareBtn","apiBase"];
const missing = ids.filter(id => !document.getElementById(id));
if (missing.length) {
  alert("‚ö†Ô∏è √âl√©ments introuvables: " + missing.join(", "));
} else {
  alert("üëç Tous les √©l√©ments cl√©s ont √©t√© trouv√©s");
}

/* Branche trois clics de test (suffisant pour valider que √ßa marche) */
document.getElementById("testBtn")   ?.addEventListener("click", () => alert("‚úÖ Click TEST OK"));
document.getElementById("loginBtn")  ?.addEventListener("click", () => alert("‚úÖ Click LOGIN OK"));
document.getElementById("mintBtn")   ?.addEventListener("click", () => alert("‚úÖ Click MINT OK"));
</script>
</body>
</html>
