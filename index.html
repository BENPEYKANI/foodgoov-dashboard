<!doctype html>
<html lang="fr" class="bg-gray-50 text-gray-900">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FoodGoov Dashboard</title>
  <meta name="description" content="Dashboard FoodGoov — traçabilité et tokenisation produit" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel for inline JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script>
    // Mode clair/sombre custom via data-theme sur <html>
    // On ajoute nos couleurs dynamiques ici pour Tailwind
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              DEFAULT: "#16a34a", /* vert FoodGoov */
              fg: "#16a34a",
            },
            surface: {
              light: "#ffffff",
              dark: "#1f2937"
            },
            panel: {
              light: "#ffffff",
              dark: "#111827"
            },
            soft: {
              light: "#f9fafb",
              dark: "#1f2937"
            },
            bordercol: {
              light: "#e5e7eb",
              dark: "#374151"
            },
            textmain: {
              light: "#0f172a",
              dark: "#f8fafc"
            },
            textsub: {
              light: "#6b7280",
              dark: "#9ca3af"
            }
          },
          boxShadow: {
            card: "0 24px 48px -12px rgb(0 0 0 / 0.12)",
          },
          borderRadius: {
            xl2: "1rem",
            xl3: "1.25rem",
            full: "9999px",
          }
        }
      }
    }
  </script>

  <style>
    /* Gestion du thème clair/sombre via l'attribut data-theme sur le html */
    html[data-theme='dark'] {
      background-color: #0f172a;
      color: #f8fafc;
    }
  </style>
</head>

<body class="min-h-screen transition-colors duration-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // ---- utilitaires UI réutilisables ----
    const STORAGE_KEY = "foodgoov_dash_cfg_v2";
    const THEME_KEY = "foodgoov_theme";

    function setThemeAttr(mode) {
      document.documentElement.setAttribute("data-theme", mode);
    }

    function useTheme() {
      const [theme, setTheme] = useState(() => {
        const saved = localStorage.getItem(THEME_KEY);
        return saved === "dark" ? "dark" : "light";
      });

      useEffect(() => {
        setThemeAttr(theme);
        localStorage.setItem(THEME_KEY, theme);
      }, [theme]);

      function toggle() {
        setTheme(t => (t === "dark" ? "light" : "dark"));
      }

      return { theme, toggle };
    }

    function classNames(...arr) {
      return arr.filter(Boolean).join(" ");
    }

    function Card({children}) {
      // panneau visuel type SaaS
      return (
        <div
          className="
            rounded-2xl
            shadow-card
            border
            p-6
            bg-[color:var(--panel-bg)]
            border-[color:var(--border-col)]
          "
          style={{
            "--panel-bg": getComputedStyle(document.documentElement)
              .getPropertyValue("--panel-bg") || "",
            "--border-col": getComputedStyle(document.documentElement)
              .getPropertyValue("--border-col") || "",
          }}
        >
          {children}
        </div>
      );
    }

    function Input({className="", ...props}) {
      return (
        <input
          {...props}
          className={
            "w-full rounded-xl border px-3 py-2 outline-none text-sm " +
            "focus:ring-2 " +
            className +
            " border-[color:var(--border-col)] bg-[color:var(--panel-bg)] text-[color:var(--text-main)] focus:ring-brand/30"
          }
          style={styleVars()}
        />
      );
    }

    function Textarea({className="", ...props}) {
      return (
        <textarea
          {...props}
          className={
            "w-full rounded-xl border px-3 py-2 outline-none text-sm " +
            "focus:ring-2 " +
            className +
            " border-[color:var(--border-col)] bg-[color:var(--panel-bg)] text-[color:var(--text-main)] focus:ring-brand/30"
          }
          style={styleVars()}
        />
      );
    }

    function Button({children, className="", ...props}) {
      return (
        <button
          {...props}
          className={
            "rounded-full px-4 py-2 text-sm font-medium shadow " +
            "bg-brand text-white hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed " +
            className
          }
        >
          {children}
        </button>
      );
    }

    function SubButton({children, className="", ...props}) {
      return (
        <button
          {...props}
          className={
            "rounded-full px-4 py-2 text-sm font-medium " +
            "border border-[color:var(--border-col)] bg-[color:var(--panel-bg)] text-[color:var(--text-main)] " +
            "hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed " +
            className
          }
          style={styleVars()}
        >
          {children}
        </button>
      );
    }

    function Field({label, children}) {
      return (
        <div className="flex flex-col text-sm mb-4">
          {label && (
            <div
              className="mb-1 font-medium"
              style={{ color: getVar("--text-sub") }}
            >
              {label}
            </div>
          )}
          {children}
        </div>
      );
    }

    function Badge({ok, children}) {
      return (
        <span
          className={classNames(
            "inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-medium",
            ok
              ? "bg-emerald-600 text-white"
              : "bg-red-600 text-white"
          )}
        >
          <span
            className={classNames(
              "w-2 h-2 rounded-full",
              ok ? "bg-white" : "bg-white"
            )}
          ></span>
          {children}
        </span>
      );
    }

    function InfoRow({label, value, mono}) {
      return (
        <div className="text-xs flex flex-col">
          <div
            className="font-medium"
            style={{ color: getVar("--text-main") }}
          >
            {label}
          </div>
          <div
            className={classNames(
              "truncate",
              mono ? "font-mono" : "text-[color:var(--text-sub)]"
            )}
            style={{ color: mono ? getVar("--text-main") : getVar("--text-sub") }}
            title={value}
          >
            {value}
          </div>
        </div>
      );
    }

    function Copy({text}) {
      const [done, setDone] = React.useState(false);
      return (
        <button
          className="text-[10px] underline text-brand font-medium"
          onClick={async () => {
            try {
              await navigator.clipboard.writeText(text);
              setDone(true);
              setTimeout(() => setDone(false), 1200);
            } catch {}
          }}
        >
          {done ? "Copié" : "Copier"}
        </button>
      );
    }

    // helpers de thèmes dynamiques (CSS vars)
    function styleVars() {
      return {
        "--panel-bg": getVar("--panel-bg"),
        "--border-col": getVar("--border-col"),
        "--text-main": getVar("--text-main"),
        "--text-sub": getVar("--text-sub"),
      };
    }

    function getVar(name) {
      return getComputedStyle(document.documentElement).getPropertyValue(name);
    }

    // -- logique app
    function useConfig() {
      const [apiBase, setApiBase] = useState("https://foodgoov.onrender.com");
      const [apiKey, setApiKey] = useState("");

      useEffect(() => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            const j = JSON.parse(raw);
            if (j.apiBase) setApiBase(j.apiBase);
            if (j.apiKey) setApiKey(j.apiKey);
          }
        } catch {}
      }, []);

      useEffect(() => {
        localStorage.setItem(
          STORAGE_KEY,
          JSON.stringify({ apiBase, apiKey })
        );
      }, [apiBase, apiKey]);

      return { apiBase, setApiBase, apiKey, setApiKey };
    }

    function prettyDate(s) {
      try {
        if (!s) return "";
        const d = new Date(s);
        return d.toLocaleString();
      } catch {
        return s;
      }
    }

    function App() {
      const { apiBase, setApiBase, apiKey, setApiKey } = useConfig();
      const { theme, toggle } = useTheme();

      const [statusMsg, setStatusMsg] = useState("");
      const [statusOK, setStatusOK] = useState(null); // true/false/null
      const [loading, setLoading] = useState(false);

      const [tokens, setTokens] = useState([]);
      const [limit, setLimit] = useState(25);
      const [offset, setOffset] = useState(0);

      const [mintBody, setMintBody] = useState(() =>
        JSON.stringify(
          {
            product: {
              category: "wine",
              domain_id: "DOM-001",
              vintage_year: 2024,
              batch_code: "BATCH-001",
              quantity: { unit: "bottle", count: 1200 }
            },
            issuance: {
              issued_at: new Date().toISOString(),
              issuer: "FoodGoov",
              producer_id: "DOMAINE-MASSEMBRE"
            }
          },
          null,
          2
        )
      );
      const [mintResult, setMintResult] = useState(null);

      async function testAPI() {
        setStatusMsg("Test en cours…");
        setStatusOK(null);
        try {
          const r = await fetch(`${apiBase}/v1/anchors/latest`);
          if (!r.ok) throw new Error("HTTP " + r.status);
          setStatusMsg("API OK");
          setStatusOK(true);
        } catch (err) {
          setStatusMsg("Connexion impossible");
          setStatusOK(false);
        }
      }

      async function loadTokens() {
        setLoading(true);
        try {
          const r = await fetch(
            `${apiBase}/v1/admin/tokens?limit=${limit}&offset=${offset}`,
            {
              headers: {
                "x-api-key": apiKey
              }
            }
          );
          const j = await r.json();
          if (!r.ok) throw new Error(j?.detail || r.statusText);

          setTokens(Array.isArray(j.items) ? j.items : []);
          setStatusMsg(`Chargé (${j.items?.length || 0})`);
          setStatusOK(true);
        } catch (err) {
          setStatusMsg("Erreur chargement tokens");
          setStatusOK(false);
        } finally {
          setLoading(false);
        }
      }

      async function mintToken() {
        setLoading(true);
        setMintResult(null);
        try {
          const r = await fetch(`${apiBase}/v1/tokens`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-api-key": apiKey
            },
            body: mintBody
          });
          const j = await r.json();
          if (!r.ok) throw new Error(j?.detail || r.statusText);
          setMintResult(j);
          setStatusMsg("Token minté ✅");
          setStatusOK(true);
        } catch (err) {
          setMintResult({ error: String(err.message || err) });
          setStatusMsg("Erreur mint");
          setStatusOK(false);
        } finally {
          setLoading(false);
        }
      }

      // -- définir les variables CSS du thème actif
      useEffect(() => {
        if (theme === "dark") {
          document.documentElement.style.setProperty("--panel-bg", "#1f2937");
          document.documentElement.style.setProperty("--border-col", "#374151");
          document.documentElement.style.setProperty("--text-main", "#f8fafc");
          document.documentElement.style.setProperty("--text-sub", "#9ca3af");
          document.body.style.backgroundColor = "#0f172a";
          document.body.style.color = "#f8fafc";
        } else {
          document.documentElement.style.setProperty("--panel-bg", "#ffffff");
          document.documentElement.style.setProperty("--border-col", "#e5e7eb");
          document.documentElement.style.setProperty("--text-main", "#0f172a");
          document.documentElement.style.setProperty("--text-sub", "#6b7280");
          document.body.style.backgroundColor = "#f9fafb";
          document.body.style.color = "#0f172a";
        }
      }, [theme]);

      return (
        <div className="max-w-7xl mx-auto p-4 md:p-8 space-y-8">
          {/* HEADER / BRAND BAR */}
          <header className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div className="flex items-start md:items-center gap-3">
              {/* Logo simple: rond vert + texte */}
              <div className="flex items-center justify-center w-10 h-10 rounded-full bg-brand text-white font-semibold text-sm shadow-lg">
                FG
              </div>
              <div>
                <div
                  className="text-xl font-semibold leading-tight"
                  style={{ color: getVar("--text-main") }}
                >
                  FoodGoov Dashboard
                </div>
                <div
                  className="text-sm"
                  style={{ color: getVar("--text-sub") }}
                >
                  Traçabilité produit • Tokenisation sécurisée
                </div>
              </div>
            </div>

            <div className="flex flex-col items-start md:items-end gap-2 text-sm">
              <div className="flex items-center gap-2">
                {statusOK === null ? (
                  <Badge ok={true}>Idle</Badge>
                ) : statusOK === true ? (
                  <Badge ok={true}>{statusMsg}</Badge>
                ) : (
                  <Badge ok={false}>{statusMsg}</Badge>
                )}

                <SubButton onClick={testAPI}>Test API</SubButton>
                <SubButton onClick={toggle}>
                  {theme === "dark" ? "☀️ Light" : "🌙 Dark"}
                </SubButton>
              </div>
              <div
                className="text-[11px] font-mono truncate max-w-[240px]"
                style={{ color: getVar("--text-sub") }}
                title={apiBase}
              >
                {apiBase}
              </div>
            </div>
          </header>

          {/* CONFIG BAR */}
          <Card>
            <div className="grid md:grid-cols-3 gap-6 items-end">
              <Field label="API Base URL">
                <Input
                  placeholder="https://foodgoov.onrender.com"
                  value={apiBase}
                  onChange={(e) => setApiBase(e.target.value)}
                />
              </Field>

              <Field label="API Key (x-api-key)">
                <Input
                  placeholder="FG_API_KEY"
                  value={apiKey}
                  onChange={(e) => setApiKey(e.target.value)}
                />
              </Field>

              <div className="flex flex-wrap gap-2">
                <Button onClick={testAPI}>Tester</Button>
                <Button
                  onClick={loadTokens}
                  disabled={!apiBase || !apiKey || loading}
                >
                  Charger tokens
                </Button>
              </div>
            </div>
          </Card>

          {/* MAIN GRID */}
          <div className="grid md:grid-cols-3 gap-8">
            {/* TOKEN LIST */}
            <Card>
              <h2
                className="text-lg font-semibold mb-4 flex items-center gap-2"
                style={{ color: getVar("--text-main") }}
              >
                <span>Tokens existants</span>
                <span className="text-xs font-normal text-brand bg-brand/10 px-2 py-0.5 rounded-full">
                  privé
                </span>
              </h2>

              <div className="flex flex-wrap items-end gap-3 mb-4 text-sm">
                <Field label="Limit">
                  <Input
                    type="number"
                    className="w-20"
                    value={limit}
                    onChange={(e) => setLimit(Number(e.target.value))}
                  />
                </Field>
                <Field label="Offset">
                  <Input
                    type="number"
                    className="w-20"
                    value={offset}
                    onChange={(e) => setOffset(Number(e.target.value))}
                  />
                </Field>
                <Button
                  onClick={loadTokens}
                  disabled={loading}
                  className="whitespace-nowrap"
                >
                  Refresh
                </Button>
              </div>

              <div className="space-y-3 max-h-80 overflow-auto pr-2 text-sm">
                {tokens.length === 0 && (
                  <div
                    className="text-sm"
                    style={{ color: getVar("--text-sub") }}
                  >
                    Aucun token chargé. Tester l’API puis Charger tokens.
                  </div>
                )}

                {tokens.map((t, i) => (
                  <div
                    key={t.token_id || i}
                    className="rounded-xl border p-4 bg-[color:var(--panel-bg)] border-[color:var(--border-col)] shadow-sm"
                    style={styleVars()}
                  >
                    <div className="flex items-start justify-between gap-3">
                      <div className="min-w-0">
                        <div
                          className="font-mono text-xs break-all"
                          style={{ color: getVar("--text-main") }}
                        >
                          {t.token_id}
                        </div>
                      </div>
                      <Copy text={t.token_id || ""} />
                    </div>

                    <div
                      className="mt-2 text-xs leading-relaxed"
                      style={{ color: getVar("--text-sub") }}
                    >
                      <div className="font-medium text-[color:var(--text-main)]">
                        {t.domain_id} • {t.vintage_year} • {t.batch_code}
                      </div>
                      <div>
                        {prettyDate(t.issued_at)} • {t.issuer}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </Card>

            {/* MINT PANEL */}
            <Card>
              <h2
                className="text-lg font-semibold mb-4"
                style={{ color: getVar("--text-main") }}
              >
                Mint (création de token)
              </h2>

              <Textarea
                rows={20}
                value={mintBody}
                onChange={(e) => setMintBody(e.target.value)}
              />

              <div className="flex flex-wrap items-center gap-3 mt-4 text-sm">
                <Button
                  onClick={mintToken}
                  disabled={!apiBase || !apiKey || loading}
                >
                  Mint token
                </Button>

                {mintResult?.token_id && (
                  <>
                    <a
                      href={mintResult.qr_url}
                      className="underline text-brand font-medium"
                      target="_blank"
                      rel="noreferrer"
                    >
                      Voir QR
                    </a>
                    <Copy text={mintResult.token_id} />
                  </>
                )}

                {mintResult?.error && (
                  <span className="text-red-500 text-xs">
                    {mintResult.error}
                  </span>
                )}
              </div>
            </Card>

            {/* HELP PANEL */}
            <Card>
              <h2
                className="text-lg font-semibold mb-4"
                style={{ color: getVar("--text-main") }}
              >
                Aide & API
              </h2>

              <div className="space-y-4 text-sm">
                <InfoRow
                  label="API publique"
                  value="GET /v1/anchors/latest"
                />
                <InfoRow
                  label="Lister tokens (privé)"
                  value="GET /v1/admin/tokens  (x-api-key)"
                />
                <InfoRow
                  label="Créer token (privé)"
                  value="POST /v1/tokens  (JSON + x-api-key)"
                />
                <InfoRow
                  label="Sécurité"
                  value="La clé API ne quitte jamais ton navigateur"
                />
                <InfoRow
                  label="LocalStorage"
                  value="URL + clé gardées en local"
                />
              </div>

              <div className="mt-6">
                <div
                  className="text-xs font-medium uppercase tracking-wide mb-2"
                  style={{ color: getVar("--text-sub") }}
                >
                  Apparence
                </div>
                <div className="flex gap-2 text-sm">
                  <SubButton onClick={toggle}>
                    {theme === "dark" ? "☀︎ Mode clair" : "🌙 Mode sombre"}
                  </SubButton>
                </div>
                <div
                  className="text-[11px] mt-3 leading-relaxed"
                  style={{ color: getVar("--text-sub") }}
                >
                  Le mode choisi est mémorisé sur cet appareil.
                </div>
              </div>
            </Card>
          </div>
        </div>
      );
    }

    // Render app
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
