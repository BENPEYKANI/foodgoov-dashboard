<!doctype html>
<html lang="fr" class="bg-gray-50 text-gray-900">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FoodGoov Dashboard</title>
  <meta name="description" content="Dashboard FoodGoov — traçabilité et tokenisation produit" />
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel for inline JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script>
    // Theme config for Tailwind + custom tokens
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              DEFAULT: "#16a34a"
            }
          },
          boxShadow: {
            card: "0 24px 48px -12px rgb(0 0 0 / 0.12)",
          },
          borderRadius: {
            xl2: "1rem",
            xl3: "1.25rem",
            full: "9999px",
          }
        }
      }
    }
  </script>

  <style>
    html[data-theme='dark'] {
      background-color: #0f172a;
      color: #f8fafc;
    }
  </style>
</head>

<body class="min-h-screen transition-colors duration-300">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // storage keys
    const STORAGE_KEY = "foodgoov_dash_cfg_v3";
    const THEME_KEY = "foodgoov_theme";

    // ----- theme helpers -----
    function setThemeAttr(mode) {
      document.documentElement.setAttribute("data-theme", mode);
    }

    function useTheme() {
      const [theme, setTheme] = useState(() => {
        const saved = localStorage.getItem(THEME_KEY);
        return saved === "dark" ? "dark" : "light";
      });

      useEffect(() => {
        setThemeAttr(theme);
        localStorage.setItem(THEME_KEY, theme);
      }, [theme]);

      function toggle() {
        setTheme((t) => (t === "dark" ? "light" : "dark"));
      }

      return { theme, toggle };
    }

    // ----- style helpers -----
    function classNames(...arr) {
      return arr.filter(Boolean).join(" ");
    }

    function getVar(name) {
      return getComputedStyle(document.documentElement).getPropertyValue(name);
    }

    function styleVars() {
      return {
        "--panel-bg": getVar("--panel-bg"),
        "--border-col": getVar("--border-col"),
        "--text-main": getVar("--text-main"),
        "--text-sub": getVar("--text-sub"),
      };
    }

    function Card({ children }) {
      return (
        <div
          className="
            rounded-2xl
            shadow-card
            border
            p-6
            bg-[color:var(--panel-bg)]
            border-[color:var(--border-col)]
          "
          style={styleVars()}
        >
          {children}
        </div>
      );
    }

    function Input({ className = "", ...props }) {
      return (
        <input
          {...props}
          className={
            "w-full rounded-xl border px-3 py-2 outline-none text-sm " +
            "focus:ring-2 " +
            className +
            " border-[color:var(--border-col)] bg-[color:var(--panel-bg)] text-[color:var(--text-main)] focus:ring-brand/30"
          }
          style={styleVars()}
        />
      );
    }

    function Textarea({ className = "", ...props }) {
      return (
        <textarea
          {...props}
          className={
            "w-full rounded-xl border px-3 py-2 outline-none text-sm " +
            "focus:ring-2 " +
            className +
            " border-[color:var(--border-col)] bg-[color:var(--panel-bg)] text-[color:var(--text-main)] focus:ring-brand/30"
          }
          style={styleVars()}
        />
      );
    }

    function Button({ children, className = "", ...props }) {
      return (
        <button
          {...props}
          className={
            "rounded-full px-4 py-2 text-sm font-medium shadow " +
            "bg-brand text-white hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed " +
            className
          }
        >
          {children}
        </button>
      );
    }

    function SubButton({ children, className = "", ...props }) {
      return (
        <button
          {...props}
          className={
            "rounded-full px-4 py-2 text-sm font-medium " +
            "border border-[color:var(--border-col)] bg-[color:var(--panel-bg)] text-[color:var(--text-main)] " +
            "hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed " +
            className
          }
          style={styleVars()}
        >
          {children}
        </button>
      );
    }

    function Field({ label, children }) {
      return (
        <div className="flex flex-col text-sm mb-4">
          {label && (
            <div
              className="mb-1 font-medium"
              style={{ color: getVar("--text-sub") }}
            >
              {label}
            </div>
          )}
          {children}
        </div>
      );
    }

    function Badge({ ok, children }) {
      return (
        <span
          className={classNames(
            "inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-medium",
            ok ? "bg-emerald-600 text-white" : "bg-red-600 text-white"
          )}
        >
          <span
            className={classNames(
              "w-2 h-2 rounded-full",
              ok ? "bg-white" : "bg-white"
            )}
          ></span>
          {children}
        </span>
      );
    }

    function Copy({ text }) {
      const [done, setDone] = useState(false);
      return (
        <button
          className="text-[10px] underline text-brand font-medium"
          onClick={async () => {
            try {
              await navigator.clipboard.writeText(text);
              setDone(true);
              setTimeout(() => setDone(false), 1200);
            } catch {}
          }}
        >
          {done ? "Copié" : "Copier"}
        </button>
      );
    }

    function InfoStat({ label, value, sub }) {
      return (
        <div className="flex flex-col min-w-[120px]">
          <div
            className="text-xs uppercase font-medium tracking-wide mb-1"
            style={{ color: getVar("--text-sub") }}
          >
            {label}
          </div>
          <div
            className="text-xl font-semibold leading-none"
            style={{ color: getVar("--text-main") }}
          >
            {value}
          </div>
          {sub && (
            <div
              className="text-[11px] leading-tight"
              style={{ color: getVar("--text-sub") }}
            >
              {sub}
            </div>
          )}
        </div>
      );
    }

    function prettyDate(s) {
      try {
        if (!s) return "";
        const d = new Date(s);
        return d.toLocaleString();
      } catch {
        return s;
      }
    }

    // config (apiBase, apiKey) stockée dans localStorage
    function useConfig() {
      const [apiBase, setApiBase] = useState("https://foodgoov.onrender.com");
      const [apiKey, setApiKey] = useState("");

      useEffect(() => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            const j = JSON.parse(raw);
            if (j.apiBase) setApiBase(j.apiBase);
            if (j.apiKey) setApiKey(j.apiKey);
          }
        } catch {}
      }, []);

      useEffect(() => {
        localStorage.setItem(
          STORAGE_KEY,
          JSON.stringify({ apiBase, apiKey })
        );
      }, [apiBase, apiKey]);

      return { apiBase, setApiBase, apiKey, setApiKey };
    }

    function App() {
      const { apiBase, setApiBase, apiKey, setApiKey } = useConfig();
      const { theme, toggle } = useTheme();

      // état global
      const [statusMsg, setStatusMsg] = useState("");
      const [statusOK, setStatusOK] = useState(null); // true/false/null
      const [loading, setLoading] = useState(false);

      const [tokens, setTokens] = useState([]);
      const [limit, setLimit] = useState(100);
      const [offset, setOffset] = useState(0);

      // analytics dérivés des tokens
      const [stats, setStats] = useState({
        totalTokens: 0,
        totalVolume: 0,
        distinctDomains: 0,
        byCategory: {},
      });

      const [mintBody, setMintBody] = useState(() =>
        JSON.stringify(
          {
            product: {
              category: "wine",
              domain_id: "DOM-001",
              vintage_year: 2024,
              batch_code: "BATCH-001",
              quantity: { unit: "bottle", count: 1200 }
            },
            issuance: {
              issued_at: new Date().toISOString(),
              issuer: "FoodGoov",
              producer_id: "DOMAINE-MASSEMBRE"
            }
          },
          null,
          2
        )
      );
      const [mintResult, setMintResult] = useState(null);

      // à chaque changement de tokens, recalculer les stats
      useEffect(() => {
        const s = computeStats(tokens);
        setStats(s);
      }, [tokens]);

      function computeStats(items) {
        // total tokens
        const totalTokens = items.length;

        // total volume : sum(quantity.count) si présent
        let totalVolume = 0;
        // distinct domain_id
        const domainSet = new Set();
        // by category
        const categoryMap = {};

        for (const t of items) {
          // volume
          // dans l'API list_tokens on remet quantity comme {unit,count}
          if (t.quantity && typeof t.quantity.count === "number") {
            totalVolume += t.quantity.count;
          }

          // domain
          if (t.domain_id) {
            domainSet.add(t.domain_id);
          }

          // category
          if (t.category) {
            categoryMap[t.category] = (categoryMap[t.category] || 0) + 1;
          }
        }

        const distinctDomains = domainSet.size;

        return {
          totalTokens,
          totalVolume,
          distinctDomains,
          byCategory: categoryMap,
        };
      }

      // test API santé
      async function testAPI() {
        setStatusMsg("Test en cours…");
        setStatusOK(null);
        try {
          const r = await fetch(`${apiBase}/v1/anchors/latest`);
          if (!r.ok) throw new Error("HTTP " + r.status);
          setStatusMsg("API OK");
          setStatusOK(true);
        } catch (err) {
          setStatusMsg("Connexion impossible");
          setStatusOK(false);
        }
      }

      // charge les tokens
      async function loadTokens() {
        setLoading(true);
        try {
          const r = await fetch(
            `${apiBase}/v1/admin/tokens?limit=${limit}&offset=${offset}`,
            {
              headers: {
                "x-api-key": apiKey
              }
            }
          );
          const j = await r.json();
          if (!r.ok) throw new Error(j?.detail || r.statusText);

          setTokens(Array.isArray(j.items) ? j.items : []);
          setStatusMsg(`Chargé (${j.items?.length || 0})`);
          setStatusOK(true);
        } catch (err) {
          setTokens([]);
          setStatusMsg("Erreur chargement tokens");
          setStatusOK(false);
        } finally {
          setLoading(false);
        }
      }

      // créer un token
      async function mintToken() {
        setLoading(true);
        setMintResult(null);
        try {
          const r = await fetch(`${apiBase}/v1/tokens`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-api-key": apiKey
            },
            body: mintBody
          });
          const j = await r.json();
          if (!r.ok) throw new Error(j?.detail || r.statusText);
          setMintResult(j);
          setStatusMsg("Token minté ✅");
          setStatusOK(true);
        } catch (err) {
          setMintResult({ error: String(err.message || err) });
          setStatusMsg("Erreur mint");
          setStatusOK(false);
        } finally {
          setLoading(false);
        }
      }

      // appliquer couleurs selon theme
      useEffect(() => {
        if (theme === "dark") {
          document.documentElement.style.setProperty("--panel-bg", "#1f2937");
          document.documentElement.style.setProperty("--border-col", "#374151");
          document.documentElement.style.setProperty("--text-main", "#f8fafc");
          document.documentElement.style.setProperty("--text-sub", "#9ca3af");
          document.body.style.backgroundColor = "#0f172a";
          document.body.style.color = "#f8fafc";
        } else {
          document.documentElement.style.setProperty("--panel-bg", "#ffffff");
          document.documentElement.style.setProperty("--border-col", "#e5e7eb");
          document.documentElement.style.setProperty("--text-main", "#0f172a");
          document.documentElement.style.setProperty("--text-sub", "#6b7280");
          document.body.style.backgroundColor = "#f9fafb";
          document.body.style.color = "#0f172a";
        }
      }, [theme]);

      return (
        <div className="max-w-7xl mx-auto p-4 md:p-8 space-y-8">
          {/* HEADER */}
          <header className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div className="flex items-start md:items-center gap-3">
              <div className="flex items-center justify-center w-10 h-10 rounded-full bg-brand text-white font-semibold text-sm shadow-lg">
                FG
              </div>
              <div>
                <div
                  className="text-xl font-semibold leading-tight"
                  style={{ color: getVar("--text-main") }}
                >
                  FoodGoov Dashboard
                </div>
                <div
                  className="text-sm"
                  style={{ color: getVar("--text-sub") }}
                >
                  Traçabilité produit • Tokenisation sécurisée
                </div>
              </div>
            </div>

            <div className="flex flex-col items-start md:items-end gap-2 text-sm">
              <div className="flex items-center gap-2 flex-wrap">
                {statusOK === null ? (
                  <Badge ok={true}>Idle</Badge>
                ) : statusOK === true ? (
                  <Badge ok={true}>{statusMsg}</Badge>
                ) : (
                  <Badge ok={false}>{statusMsg}</Badge>
                )}

                <SubButton onClick={testAPI}>Test API</SubButton>
                <SubButton onClick={toggle}>
                  {theme === "dark" ? "☀️ Light" : "🌙 Dark"}
                </SubButton>
              </div>
              <div
                className="text-[11px] font-mono truncate max-w-[240px]"
                style={{ color: getVar("--text-sub") }}
                title={apiBase}
              >
                {apiBase}
              </div>
            </div>
          </header>

          {/* CONFIG */}
          <Card>
            <div className="grid md:grid-cols-3 gap-6 items-end">
              <Field label="API Base URL">
                <Input
                  placeholder="https://foodgoov.onrender.com"
                  value={apiBase}
                  onChange={(e) => setApiBase(e.target.value)}
                />
              </Field>

              <Field label="API Key (x-api-key)">
                <Input
                  placeholder="FG_API_KEY"
                  value={apiKey}
                  onChange={(e) => setApiKey(e.target.value)}
                />
              </Field>

              <div className="flex flex-wrap gap-2">
                <Button onClick={testAPI}>Tester</Button>
                <Button
                  onClick={loadTokens}
                  disabled={!apiBase || !apiKey || loading}
                >
                  Charger tokens
                </Button>
              </div>
            </div>
          </Card>

          {/* ANALYTICS SECTION */}
          <div className="grid md:grid-cols-4 gap-4">
            <Card>
              <InfoStat
                label="Tokens mintés"
                value={stats.totalTokens}
                sub="Total enregistré"
              />
            </Card>

            <Card>
              <InfoStat
                label="Volume total"
                value={stats.totalVolume}
                sub="Total quantité (ex: bouteilles)"
              />
            </Card>

            <Card>
              <InfoStat
                label="Domaines"
                value={stats.distinctDomains}
                sub="Producteurs uniques"
              />
            </Card>

            <Card>
              <div className="flex flex-col min-w-[120px]">
                <div
                  className="text-xs uppercase font-medium tracking-wide mb-1"
                  style={{ color: getVar("--text-sub") }}
                >
                  Par catégorie
                </div>
                <div
                  className="text-sm leading-tight space-y-1"
                  style={{ color: getVar("--text-main") }}
                >
                  {Object.keys(stats.byCategory).length === 0 && (
                    <div
                      className="text-[11px]"
                      style={{ color: getVar("--text-sub") }}
                    >
                      —
                    </div>
                  )}

                  {Object.entries(stats.byCategory).map(
                    ([cat, nb]) => (
                      <div
                        key={cat}
                        className="flex items-center gap-2"
                      >
                        <span className="inline-flex items-center justify-center w-2 h-2 rounded-full bg-brand"></span>
                        <span className="text-xs font-medium">
                          {cat} :
                        </span>
                        <span className="text-xs text-[color:var(--text-sub)]">
                          {nb}
                        </span>
                      </div>
                    )
                  )}
                </div>
              </div>
            </Card>
          </div>

          {/* MAIN GRID */}
          <div className="grid md:grid-cols-3 gap-8">
            {/* TOKEN LIST */}
            <Card>
              <h2
                className="text-lg font-semibold mb-4 flex items-center gap-2"
                style={{ color: getVar("--text-main") }}
              >
                <span>Tokens existants</span>
                <span className="text-xs font-normal text-brand bg-brand/10 px-2 py-0.5 rounded-full">
                  privé
                </span>
              </h2>

              <div className="flex flex-wrap items-end gap-3 mb-4 text-sm">
                <Field label="Limit">
                  <Input
                    type="number"
                    className="w-20"
                    value={limit}
                    onChange={(e) => setLimit(Number(e.target.value))}
                  />
                </Field>
                <Field label="Offset">
                  <Input
                    type="number"
                    className="w-20"
                    value={offset}
                    onChange={(e) => setOffset(Number(e.target.value))}
                  />
                </Field>
                <Button
                  onClick={loadTokens}
                  disabled={loading}
                  className="whitespace-nowrap"
                >
                  Refresh
                </Button>
              </div>

              <div className="space-y-3 max-h-80 overflow-auto pr-2 text-sm">
                {tokens.length === 0 && (
                  <div
                    className="text-sm"
                    style={{ color: getVar("--text-sub") }}
                  >
                    Aucun token chargé. Tester l’API puis Charger tokens.
                  </div>
                )}

                {tokens.map((t, i) => (
                  <div
                    key={t.token_id || i}
                    className="rounded-xl border p-4 bg-[color:var(--panel-bg)] border-[color:var(--border-col)] shadow-sm"
                    style={styleVars()}
                  >
                    <div className="flex items-start justify-between gap-3">
                      <div className="min-w-0">
                        <div
                          className="font-mono text-xs break-all"
                          style={{ color: getVar("--text-main") }}
                        >
                          {t.token_id}
                        </div>
                      </div>
                      <Copy text={t.token_id || ""} />
                    </div>

                    <div
                      className="mt-2 text-xs leading-relaxed"
                      style={{ color: getVar("--text-sub") }}
                    >
                      <div className="font-medium text-[color:var(--text-main)]">
                        {t.domain_id} • {t.vintage_year} • {t.batch_code}
                      </div>
                      <div>
                        {prettyDate(t.issued_at)} • {t.issuer}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </Card>

            {/* MINT PANEL */}
            <Card>
              <h2
                className="text-lg font-semibold mb-4"
                style={{ color: getVar("--text-main") }}
              >
                Mint (création de token)
              </h2>

              <Textarea
                rows={20}
                value={mintBody}
                onChange={(e) => setMintBody(e.target.value)}
              />

              <div className="flex flex-wrap items-center gap-3 mt-4 text-sm">
                <Button
                  onClick={mintToken}
                  disabled={!apiBase || !apiKey || loading}
                >
                  Mint token
                </Button>

                {mintResult?.token_id && (
                  <>
                    <a
                      href={mintResult.qr_url}
                      className="underline text-brand font-medium"
                      target="_blank"
                      rel="noreferrer"
                    >
                      Voir QR
                    </a>
                    <Copy text={mintResult.token_id} />
                  </>
                )}

                {mintResult?.error && (
                  <span className="text-red-500 text-xs">
                    {mintResult.error}
                  </span>
                )}
              </div>
            </Card>

            {/* HELP PANEL */}
            <Card>
              <h2
                className="text-lg font-semibold mb-4"
                style={{ color: getVar("--text-main") }}
              >
                Aide & API
              </h2>

              <div className="space-y-4 text-sm">
                <div>
                  <div
                    className="text-xs font-medium uppercase tracking-wide mb-1"
                    style={{ color: getVar("--text-sub") }}
                  >
                    API publique
                  </div>
                  <div
                    className="text-sm font-mono"
                    style={{ color: getVar("--text-main") }}
                  >
                    GET /v1/anchors/latest
                  </div>
                </div>

                <div>
                  <div
                    className="text-xs font-medium uppercase tracking-wide mb-1"
                    style={{ color: getVar("--text-sub") }}
                  >
                    Liste admin
                  </div>
                  <div
                    className="text-sm font-mono"
                    style={{ color: getVar("--text-main") }}
                  >
                    GET /v1/admin/tokens (x-api-key)
                  </div>
                </div>

                <div>
                  <div
                    className="text-xs font-medium uppercase tracking-wide mb-1"
                    style={{ color: getVar("--text-sub") }}
                  >
                    Mint
                  </div>
                  <div
                    className="text-sm font-mono"
                    style={{ color: getVar("--text-main") }}
                  >
                    POST /v1/tokens
                  </div>
                  <div
                    className="text-[11px]"
                    style={{ color: getVar("--text-sub") }}
                  >
                    Body JSON + header x-api-key
                  </div>
                </div>

                <div>
                  <div
                    className="text-xs font-medium uppercase tracking-wide mb-1"
                    style={{ color: getVar("--text-sub") }}
                  >
                    Sécurité
                  </div>
                  <div
                    className="text-[11px] leading-tight"
                    style={{ color: getVar("--text-sub") }}
                  >
                    La clé API reste dans ton navigateur.
                    Elle n'est jamais envoyée à un service tiers.
                  </div>
                </div>
              </div>

              <div className="mt-6">
                <div
                  className="text-xs font-medium uppercase tracking-wide mb-2"
                  style={{ color: getVar("--text-sub") }}
                >
                  Apparence
                </div>
                <div className="flex gap-2 text-sm">
                  <SubButton onClick={toggle}>
                    {theme === "dark" ? "☀︎ Mode clair" : "🌙 Mode sombre"}
                  </SubButton>
                </div>
                <div
                  className="text-[11px] mt-3 leading-relaxed"
                  style={{ color: getVar("--text-sub") }}
                >
                  Le thème, l'URL API et la clé API sont mémorisés localement
                  sur cet appareil (localStorage).
                </div>
              </div>
            </Card>
          </div>
        </div>
      );
    }

    // Render app
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
