<!doctype html>
<html lang="fr" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FoodGoov — Dashboard</title>

  <!-- QRCode CDN (pour générer le QR du lien de vérification) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- Tailwind CDN + plugins -->
  <script>
    /* La config DOIT être définie avant le script CDN Tailwind */
    tailwind = {
      config: {
        darkMode: 'class',
        theme: { extend: {} }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- Police Inter (optionnel) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <style>
    body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .btn { @apply px-4 py-2 rounded-lg text-sm font-semibold shadow border border-gray-200; }
    .btn-primary { @apply bg-indigo-700 text-white hover:bg-indigo-800; }
    .btn-muted { @apply bg-gray-100 text-gray-800 hover:bg-gray-200; }
    .card { @apply rounded-2xl border border-gray-200 p-5 bg-white; }
    .field { @apply w-full rounded-lg border-gray-300; }
    .tag { @apply text-[11px] px-2 py-0.5 rounded-full bg-gray-100; }
  </style>
</head>
<body class="bg-gray-50 min-h-full">
  <header class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-full bg-black text-white grid place-items-center font-semibold">FG</div>
        <div>
          <h1 class="text-xl font-semibold">FoodGoov — Dashboard</h1>
          <p class="text-xs text-gray-500">Traçabilité • Tokens • Vérification</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class="text-sm text-gray-500">Statut :</span>
        <span id="statusBadge" class="text-xs px-2 py-1 rounded-full bg-gray-100">Hors ligne</span>
        <button id="connectBtn" class="btn btn-primary">Se connecter</button>
        <button id="disconnectBtn" class="btn btn-muted hidden">Se déconnecter</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-16">
    <!-- Ligne 1 -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-5">
      <!-- API Base -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-700 mb-2">API Base URL</h3>
        <input id="apiBase" class="field" placeholder="https://foodgoov.onrender.com" />
        <p class="text-[11px] text-gray-400 mt-2">Mémorisé localement sur cet appareil.</p>
      </div>

      <!-- Session -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Session</h3>
        <div id="sessionBox" class="text-sm text-gray-500">—</div>
      </div>

      <!-- Actions -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Actions</h3>
        <div class="flex gap-3 flex-wrap">
          <button id="testBtn" class="btn btn-muted">Tester API publique</button>
          <button id="loadBtn" class="btn btn-muted">Charger mes tokens</button>
        </div>
      </div>
    </section>

    <!-- Ligne 2 -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-5 mt-6">
      <!-- Mes tokens -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-700">Mes tokens</h3>
          <div class="flex items-center gap-2">
            <label class="text-xs text-gray-500">Limit</label>
            <input id="limit" class="field w-20" value="25" />
            <label class="text-xs text-gray-500">Offset</label>
            <input id="offset" class="field w-20" value="0" />
            <button class="btn btn-muted" onclick="loadMyTokens()">Refresh</button>
          </div>
        </div>
        <div id="myTokens" class="text-sm text-gray-700 border-t pt-3">—</div>
      </div>

      <!-- Mint -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-700">Mint (authentifié)</h3>
          <span class="tag">POST /v1/tokens</span>
        </div>

        <textarea id="mintBody" class="field font-mono text-sm w-full h-56">
{
  "product": {
    "category": "wine",
    "domain_id": "DOM-001",
    "vintage_year": 2024,
    "batch_code": "BATCH-001",
    "quantity": { "unit": "bottle", "count": 1200 }
  },
  "issuance": {
    "issued_at": "2025-10-22T12:00:00Z",
    "issuer": "FoodGoov",
    "producer_id": "DOMAINE-MASSEMBRE"
  }
}
        </textarea>

        <div class="mt-3 flex items-center gap-3">
          <button id="mintBtn" class="btn btn-primary">Mint token</button>
          <div id="mintResult" class="text-sm text-gray-500"></div>
        </div>

        <!-- Résultat + QR -->
        <div id="qrSection" class="hidden mt-5 border-t border-gray-200 pt-4 text-center">
          <canvas id="qrCanvas" class="mx-auto mb-2"></canvas>
          <div class="flex items-center justify-center gap-3">
            <button id="shareBtn" class="btn btn-muted text-sm">Copier le lien</button>
            <p id="shareLink" class="text-[11px] text-gray-500 break-all"></p>
          </div>
        </div>
      </div>
    </section>

    <!-- Ligne 3 : Auth -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-5 mt-6">
      <!-- Connexion -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Authentification — Connexion</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-center">
          <input id="loginEmail" class="field md:col-span-1" placeholder="Email" />
          <input id="loginPassword" class="field md:col-span-1" placeholder="Mot de passe" type="password" />
          <button id="loginBtn" class="btn btn-primary md:col-span-1">Se connecter</button>
        </div>
      </div>

      <!-- Création de compte -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-700 mb-3">Authentification — Création de compte</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-center">
          <input id="signupDisplay" class="field md:col-span-2" placeholder="Nom producteur (affiché)" />
          <input id="signupEmail" class="field md:col-span-1" placeholder="Email" />
          <input id="signupPassword" class="field md:col-span-1" placeholder="Mot de passe" type="password" />
          <button id="signupBtn" class="btn btn-muted md:col-span-4">Créer mon compte</button>
        </div>
      </div>
    </section>

    <footer class="max-w-6xl mx-auto px-4 py-10 text-center text-[11px] text-gray-400">
      FoodGoov garantit l’unicité cryptographique du lot et sa déclaration par le producteur / émetteur enregistré.
    </footer>
  </main>

  <!-- =========================
       SCRIPT PRINCIPAL
       ========================= -->
  <script>
const els = {
  base: document.getElementById('apiBase') || document.querySelector('input[type="url"], #apiBaseURL'),
  session: document.getElementById('sessionBox') || document.querySelector('[data-session]'),
  mintBody: document.getElementById('mintBody'),
  mintResult: document.getElementById('mintResult'),
  qrSection: document.getElementById('qrSection'),
  qrCanvas: document.getElementById('qrCanvas'),
  shareLink: document.getElementById('shareLink'),
  loginEmail: document.getElementById('loginEmail'),
  loginPassword: document.getElementById('loginPassword'),
  signupDisplay: document.getElementById('signupDisplay'),
  signupEmail: document.getElementById('signupEmail'),
  signupPassword: document.getElementById('signupPassword'),
};

function getBase() {
  const v = (els.base?.value || '').trim().replace(/\/+$/,'');
  if (!v) throw new Error("API Base URL manquante");
  localStorage.setItem('fg_base', v);
  return v;
}
(function restoreBase(){
  const saved = localStorage.getItem('fg_base');
  if (saved && els.base) els.base.value = saved;
})();

function setSession(display, token) {
  localStorage.setItem('fg_sess', token);
  localStorage.setItem('fg_name', display || '');
  if (els.session) els.session.textContent = `${display || '—'} • ${token.slice(0,8)}…`;
}

function getSession() {
  return localStorage.getItem('fg_sess') || '';
}

async function api(path, opts = {}) {
  const base = getBase();
  const res = await fetch(`${base}${path}`, {
    headers: { 'Content-Type': 'application/json', ...(opts.headers||{}) },
    ...opts
  });
  const text = await res.text();
  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch { data = { raw: text }; }
  if (!res.ok) {
    const msg = data?.detail || data?.error || text || `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return data;
}

// --- Auth: login ---
async function login() {
  try {
    const body = {
      email: els.loginEmail.value.trim(),
      password: els.loginPassword.value
    };
    const data = await api('/v1/auth/login', { method: 'POST', body: JSON.stringify(body) });
    setSession(data.display_name, data.session_token);
    alert(`Connecté : ${data.display_name}`);
  } catch (e) {
    alert(`Connexion échouée : ${e.message}`);
  }
}

// --- Auth: signup ---
async function signup() {
  try {
    const body = {
      display_name: els.signupDisplay.value.trim(),
      email: els.signupEmail.value.trim(),
      password: els.signupPassword.value
    };
    const data = await api('/v1/auth/signup', { method: 'POST', body: JSON.stringify(body) });
    setSession(data.display_name, data.session_token);
    alert(`Compte créé : ${data.display_name}`);
  } catch (e) {
    alert(`Création échouée : ${e.message}`);
  }
}

// --- MINT ---
async function mintToken() {
  try {
    const sess = getSession();
    if (!sess) throw new Error("Connecte-toi d'abord (x-session manquant)");
    let payload;
    try { payload = JSON.parse(els.mintBody.value); }
    catch { throw new Error("JSON du mint invalide"); }

    const data = await api('/v1/tokens', {
      method: 'POST',
      headers: { 'x-session': sess },
      body: JSON.stringify(payload)
    });

    els.mintResult.textContent = `✅ Mint OK\nToken: ${data.token_id}\nQR: ${data.qr_url}`;
    renderQR(data.qr_url);
  } catch (e) {
    els.mintResult.textContent = `❌ ${e.message}`;
    if (window.console) console.error(e);
  }
}

// --- QR + partage ---
function renderQR(text) {
  try {
    const canvas = els.qrCanvas;
    const size = Math.min(320, Math.max(180, canvas.parentElement.clientWidth - 40));
    canvas.width = size; canvas.height = size;
    QRCode.toCanvas(canvas, text, { width: size, margin: 1 }, (err) => {
      if (err) { els.mintResult.textContent = '❌ QR failed'; return; }
      els.qrSection?.classList?.remove('hidden');
      els.shareLink.textContent = text;
      els.shareLink.href = text;
    });
  } catch (e) {
    if (window.console) console.error(e);
  }
}

async function copyShareLink() {
  try {
    const t = els.shareLink.textContent;
    await navigator.clipboard.writeText(t);
    alert("Lien copié");
  } catch { alert("Impossible de copier"); }
}

// Expose pour tes boutons HTML
window.login = login;
window.signup = signup;
window.mintToken = mintToken;
window.copyShareLink = copyShareLink;
</script>
</body>
</html>
