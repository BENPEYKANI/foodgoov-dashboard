<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FoodGoov — Dashboard</title>

  <!-- QRCode (pour le bouton Partager) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- Tailwind CDN + plugins -->
  <script>
    /* La config DOIT être définie avant le script CDN */
    tailwind = {
      config: {
        darkMode: 'class',
        theme: { extend: {} },
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- Police -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

  <!-- Styles simples utilitaires -->
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0b1220;color:#e6e8ec}
    .page{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:#0f172a;border:1px solid #1f2a44;border-radius:16px;padding:16px}
    .btn{display:inline-flex;align-items:center;justify-content:center;border-radius:10px;padding:.6rem 1rem;font-weight:600}
    .btn-primary{background:#0f172a;border:1px solid #334155}
    .btn-primary:hover{background:#111827}
    .btn-muted{background:#0b1220;border:1px solid #334155}
    .field{border:1px solid #334155;background:#0b1220;border-radius:10px;padding:.55rem .8rem}
    .label{font-size:.8rem;color:#9aa4b2}
    .tag{font-size:.7rem;color:#9aa4b2}
    .link{color:#60a5fa}
    .link:hover{text-decoration:underline}
    canvas{image-rendering:pixelated}
  </style>
</head>
<body class="min-h-screen">
  <main class="page">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-white text-black grid place-items-center text-sm font-bold">FG</div>
        <div>
          <h1 class="text-xl font-semibold">FoodGoov — Dashboard</h1>
          <div class="tag">Traçabilité • Tokens • Vérification</div>
        </div>
      </div>
      <div>
        <span class="label mr-2">Statut :</span>
        <span id="statusPill" class="inline-flex items-center gap-2 rounded-full px-3 py-1 border border-[#334155] text-xs">Hors ligne</span>
      </div>
    </header>

    <!-- Ligne 1 -->
    <section class="grid md:grid-cols-3 gap-4 mb-6">
      <!-- API Base URL -->
      <div class="card">
        <div class="label mb-2">API Base URL</div>
        <input id="apiBase" class="field w-full" placeholder="https://foodgoov.onrender.com" />
        <div class="tag mt-2">Mémorisé localement sur cet appareil.</div>
      </div>

      <!-- Session -->
      <div class="card">
        <div class="label mb-2">Session</div>
        <div id="sessionInfo" class="text-sm">—</div>
      </div>

      <!-- Actions -->
      <div class="card">
        <div class="label mb-3">Actions</div>
        <div class="flex gap-3">
          <button id="testBtn"  class="btn btn-muted"   type="button">Tester API publique</button>
          <button id="loadBtn"  class="btn btn-primary" type="button">Charger mes tokens</button>
        </div>
      </div>
    </section>

    <!-- Ligne 2 -->
    <section class="grid md:grid-cols-2 gap-4 mb-6">
      <!-- Mes tokens -->
      <div class="card">
        <div class="flex items-center justify-between">
          <div class="label">Mes tokens</div>
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
              <span class="label">Limit</span>
              <input id="listLimit" class="field w-20" value="25" />
            </div>
            <div class="flex items-center gap-2">
              <span class="label">Offset</span>
              <input id="listOffset" class="field w-20" value="0" />
            </div>
            <button id="refreshBtn" class="btn btn-muted" type="button">Refresh</button>
          </div>
        </div>
        <div id="tokensList" class="mt-3 text-sm">—</div>
      </div>

      <!-- Mint -->
      <div class="card">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-300">Mint (authentifié)</h3>
          <span class="tag">POST /v1/tokens</span>
        </div>

        <textarea id="mintBody" class="field w-full h-64 font-mono text-sm">
{
  "product": {
    "category": "wine",
    "domain_id": "DOM-001",
    "vintage_year": 2024,
    "batch_code": "BATCH-001",
    "quantity": { "unit": "bottle", "count": 1200 }
  },
  "issuance": {
    "issued_at": "2025-10-22T12:00:00Z",
    "issuer": "FoodGoov",
    "producer_id": "DOMAINE-MASSEMBRE"
  }
}
        </textarea>

        <div class="mt-3 flex items-center gap-3">
          <button id="mintBtn" class="btn btn-primary" type="button">Mint token</button>
        </div>
        <div id="mintResult" class="text-sm text-gray-400 mt-2"></div>

        <!-- QR / Partage -->
        <div id="qrSection" class="hidden mt-5 border-t border-[#334155] pt-4 text-center">
          <canvas id="qrCanvas" class="mx-auto mb-2"></canvas>
          <button id="shareBtn" class="btn btn-muted text-sm" type="button">Copier</button>
          <p id="shareLink" class="text-[11px] text-gray-400 mt-2"></p>
        </div>
      </div>
    </section>

    <!-- Ligne 3 : Auth -->
    <section class="grid md:grid-cols-2 gap-4">
      <!-- Connexion -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-300 mb-3">Authentification — Connexion</h3>
        <div class="grid grid-cols-3 gap-3 items-center">
          <input id="loginEmail"    class="field md:col-span-1" placeholder="Email" />
          <input id="loginPassword" class="field md:col-span-1" type="password" placeholder="Mot de passe" />
          <button id="loginBtn" class="btn btn-primary md:col-span-1" type="button">Se connecter</button>
        </div>
      </div>

      <!-- Création -->
      <div class="card">
        <h3 class="text-sm font-medium text-gray-300 mb-3">Authentification — Création de compte</h3>
        <div class="grid grid-cols-4 gap-3 items-center">
          <input id="signupDisplay"  class="field md:col-span-1" placeholder="Nom producteur (affiché)" />
          <input id="signupEmail"    class="field md:col-span-1" placeholder="Email" />
          <input id="signupPassword" class="field md:col-span-1" type="password" placeholder="Mot de passe" />
          <button id="signupBtn" class="btn btn-muted md:col-span-1" type="button">Créer mon compte</button>
        </div>
      </div>
    </section>

    <footer class="max-w-7xl mx-auto px-4 py-8 text-center text-[11px] text-gray-400">
      FoodGoov garantit l’unicité cryptographique du lot et sa déclaration par le producteur / émetteur enregistré.
    </footer>
  </main>

  <!-- Script principal -->
  <script>
    /* ---------------- State ---------------- */
    const state = {
      baseUrl: localStorage.getItem('fg_api_base') || '',
      session: JSON.parse(localStorage.getItem('fg_session') || 'null'), // {display_name, session_token, api_key}
    };

    /* --------------- Helpers --------------- */
    const qs = (id) => document.getElementById(id);
    const api = (path) => {
      const base = (qs('apiBase').value || '').trim().replace(/\/+$/,'');
      if (!base) throw new Error("API Base URL manquante");
      return base + path;
    };
    const setStatus = (text) => { qs('statusPill').textContent = text; };
    const saveBase = () => {
      const v = (qs('apiBase').value || '').trim();
      localStorage.setItem('fg_api_base', v);
    };
    const loadSessionUI = () => {
      if (state.session) {
        qs('sessionInfo').textContent = `${state.session.display_name} · ${state.session.session_token.slice(0,6)}…`;
        setStatus('En ligne');
      } else {
        qs('sessionInfo').textContent = '—';
        setStatus('Hors ligne');
      }
    };

    /* --------------- Auth APIs --------------- */
    async function signup() {
      try {
        saveBase();
        const body = {
          display_name: qs('signupDisplay').value.trim(),
          email: qs('signupEmail').value.trim(),
          password: qs('signupPassword').value.trim(),
        };
        const r = await fetch(api('/v1/auth/signup'), {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(body),
        });
        if (!r.ok) throw new Error((await r.json()).detail || 'Signup failed');
        const data = await r.json(); // {producer_id, api_key, session_token, display_name}
        state.session = data;
        localStorage.setItem('fg_session', JSON.stringify(data));
        loadSessionUI();
        alert(`Compte créé : ${data.display_name}`);
      } catch(e) { alert(`Erreur création compte : ${e.message}`); }
    }

    async function login() {
      try {
        saveBase();
        const body = {
          email: qs('loginEmail').value.trim(),
          password: qs('loginPassword').value.trim(),
        };
        const r = await fetch(api('/v1/auth/login'), {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(body),
        });
        if (!r.ok) throw new Error((await r.json()).detail || 'Login failed');
        const data = await r.json(); // {producer_id, api_key, session_token, display_name}
        state.session = data;
        localStorage.setItem('fg_session', JSON.stringify(data));
        loadSessionUI();
        alert(`Connecté : ${data.display_name}`);
      } catch(e) { alert(`Connexion échouée : ${e.message}`); }
    }

    /* --------------- Public test --------------- */
    async function testPublic() {
      try {
        saveBase();
        const r = await fetch(api('/v1/status'));
        if (!r.ok) throw new Error('API status NOK');
        await r.json();
        alert('API publique OK');
      } catch(e) { alert(`Test API publique : ${e.message}`); }
    }

    /* ----------- Tokens (list & mint) ---------- */
    async function loadMyTokens() {
      try {
        if (!state.session) throw new Error('Non connecté');
        saveBase();
        const limit = parseInt(qs('listLimit').value || '25', 10);
        const offset = parseInt(qs('listOffset').value || '0', 10);
        const r = await fetch(api(`/v1/admin/my-tokens?limit=${limit}&offset=${offset}`), {
          headers: {
            'x-session': state.session.session_token,
          }
        });
        if (!r.ok) throw new Error((await r.json()).detail || 'Load failed');
        const data = await r.json(); // {items:[...]}
        if (!data.items.length) {
          qs('tokensList').textContent = '—';
          return;
        }
        const html = data.items.map(t => {
          return `<div class="py-2 border-b border-[#1f2a44]">
            <div class="text-xs text-gray-400">${t.category} • ${t.domain_id} • ${t.vintage_year} • ${t.batch_code}</div>
            <div class="text-sm">Count: ${t.quantity.count} ${t.quantity.unit} • Issuer: ${t.issuer}</div>
          </div>`;
        }).join('');
        qs('tokensList').innerHTML = html;
      } catch(e) { alert(`Chargement échoué : ${e.message}`); }
    }

    function renderQR(tokenId) {
      const vurl = `${qs('apiBase').value.replace(/\/+$/,'')}/verify.html?token_id=${encodeURIComponent(tokenId)}`;
      const canvas = qs('qrCanvas');
      QRCode.toCanvas(canvas, vurl, {width: 200, margin: 1}, (err) => {
        if (err) { console.error(err); return; }
        qs('shareLink').textContent = vurl;
        qs('qrSection').classList.remove('hidden');
      });
      qs('shareBtn').onclick = async () => {
        try {
          await navigator.clipboard.writeText(vurl);
          qs('shareBtn').textContent = 'Copié ✓';
          setTimeout(()=> qs('shareBtn').textContent = 'Copier', 1200);
        } catch {
          alert('Impossible de copier, copie manuelle nécessaire.');
        }
      };
    }

    async function mintToken() {
      try {
        if (!state.session) throw new Error('Non connecté');
        saveBase();
        const body = JSON.parse(qs('mintBody').value);
        const r = await fetch(api('/v1/tokens'), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': state.session.api_key,     // clé d’API du producteur
            'x-session': state.session.session_token
          },
          body: JSON.stringify(body),
        });
        const out = await r.json();
        if (!r.ok) throw new Error(out.detail || 'Mint failed');
        qs('mintResult').textContent = JSON.stringify(out, null, 2);
        if (out.token_id) renderQR(out.token_id);
      } catch(e) {
        qs('mintResult').textContent = `Erreur: ${e.message}`;
      }
    }

    /* --------------- Wiring UI --------------- */
    document.addEventListener('DOMContentLoaded', () => {
      // Base URL & session
      qs('apiBase').value = state.baseUrl;
      qs('apiBase').addEventListener('change', saveBase);
      loadSessionUI();

      // Boutons
      qs('testBtn')   ?.addEventListener('click', testPublic);
      qs('loadBtn')   ?.addEventListener('click', loadMyTokens);
      qs('loginBtn')  ?.addEventListener('click', login);
      qs('signupBtn') ?.addEventListener('click', signup);
      qs('mintBtn')   ?.addEventListener('click', mintToken);
      qs('refreshBtn')?.addEventListener('click', loadMyTokens);
    });
  </script>
</body>
</html>
